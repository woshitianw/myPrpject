G.Graphic.Cluster=G.Graphic.Group.extend({options:{clickable:!0},init:function(e,r,t,o){var i=this,n=new G.Graphic.Point(null,null,{shape:"circle",size:[32],fillColor:"#000",fillOpacity:1,outline:!0,outlineColor:"#000",outlineWidth:10,outlineOpacity:.6}),s=new G.Graphic.Point(null,null,{shape:"text",size:[16],fillColor:"#fff",text:0});i.options=G.Util.merge({},i.options,o),G.Graphic.Group.prototype.init.call(i,[n,s],null,o),i._group=e,i._zoom=r,i._tree=t,i.geom=null,i.bbox=null,i._childCount=0,i._childClusters=[],i._childPoints=[]},count:function(){var e,r,t=this,o=t._childPoints.length;for(e in t._childClusters)r=t._childClusters[e],o+=r.count();return o},getNextZoom:function(){var e=this,r=e._layer,t=e._zoom;if(!r||!r._showRelZoom)return t;var o,i=r._showRelZoom,n=e;for(o=t+1;o<=i;o++){if(n._childClusters.length+n._childPoints.length>1||0==n._childClusters.length)return o;n=n._childClusters[0]}return i},_ensureStyle:function(){var e=this,r=e._layer;if(r){var t=e._childCount,o=e._graphics,i=o[0],n=o[1],s=i.options,l=n.options,a=r.options,c=a.breakValues.length,_=0;for(t<=a.breakValues[_]&&e._readLayerStyle(a,_,s,l),_=1;_<c;_++)t>a.breakValues[_-1]&&t<=a.breakValues[_]&&e._readLayerStyle(a,_,s,l);_=c,t>a.breakValues[_-1]&&e._readLayerStyle(a,_,s,l)}},_readLayerStyle:function(e,r,t,o){t.size=[e.breakShapeSizes[r]],t.fillColor=e.breakFillColors[r],t.fillOpacity=e.breakFillOpacities[r],t.outline=e.breakOutlines[r],t.outlineColor=e.breakOutlineColors[r],t.outlineOpacity=e.breakOutlineOpacities[r],t.outlineWidth=e.breakOutlineWidths[r],o.size=[e.breakTextSizes[r]],o.fillColor=e.breakTextColors[r]},_updateByAdd:function(e,r){var t=this,o=0;e instanceof G.Graphic.Cluster?!r&&t._inList(t._childClusters,e)||(o=e._childCount):!r&&t._inList(t._childPoints,e)||(o=1);var i,n,s,l,a,c=t._childCount,_=t._childCount=c+o,u=t._graphics;t.geom?e.geom&&(s=t.geom[0],l=t.geom[1],x=e.geom[0],y=e.geom[1],i=(s*c+x*o)/_,n=(l*c+y*o)/_,a=t.geom=[i,n],t.bbox=[a[0],a[1],a[0],a[1]]):a=t.geom=e.geom,a&&(u[0].updateGeom(a,!0),u[1].updateGeom(a,!0)),u[1].options.text=_},_addChild:function(e,r,t){var o=this,i=o._tree;i&&o.geom&&void 0!==o.geom[0]&&void 0!==o.geom[1]&&i.remove([o.geom[0]-1,o.geom[1]-1,o.geom[0]+1,o.geom[1]+1],o),o._updateByAdd(e),i&&i.insert(o.bbox,o),r||(e._group=o,e instanceof G.Graphic.Cluster?o._childClusters.push(e):o._childPoints.push(e)),o._group&&!t&&o._group._addChild(e,!0),o._ensureStyle()},_updateByRemove:function(e,r){var t=this,o=0;e instanceof G.Graphic.Cluster?(r||t._inList(t._childClusters,e))&&(o=e._childCount):(r||t._inList(t._childPoints,e))&&(o=1);var i,n,s,l,a,c=t._childCount,_=t._childCount=c-o,u=t._graphics;0==_?(t.geom=null,t.bbox=null,u[0].geom=null,u[0].bbox=null,u[1].geom=null,u[1].bbox=null):t.geom&&e.geom&&(s=t.geom[0],l=t.geom[1],x=e.geom[0],y=e.geom[1],i=(s*c-x*o)/_,n=(l*c-y*o)/_,a=t.geom=[i,n],t.bbox=[a[0],a[1],a[0],a[1]],u[0].updateGeom(a,!0),u[1].updateGeom(a,!0)),u[1].options.text=_},_removeChild:function(e,r,t){var o=this,i=o._tree;i&&o.geom&&void 0!==o.geom[0]&&void 0!==o.geom[1]&&i.remove([o.geom[0]-1,o.geom[1]-1,o.geom[0]+1,o.geom[1]+1],o),o._updateByRemove(e,r),i&&i.insert(o.bbox,o),r||(e._group=null,e instanceof G.Graphic.Cluster?o._removeFromList(o._childClusters,e):o._removeFromList(o._childPoints,e)),o._group&&!t&&o._group._removeChild(e,!0),o._ensureStyle()},_inList:function(e,r){return e&&e.indexOf&&e.indexOf(r)>=0},_removeFromList:function(e,r){var t,o;for(t in e)if(o=e[t],o===r){e.splice(t,1);break}},_offClickable:function(){var e=this;e.options.clickable=!1;var r,t,o=e._graphics;for(r in o)t=o[r],t.options.clickable=e.options.clickable},_onClickable:function(){var e=this;e.options.clickable=e._layer.options.clusterClickable;var r,t,o=e._graphics;for(r in o)t=o[r],t.options.clickable=e.options.clickable}}),G.Layer.Cluster=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{radius:50,showRealRes:null,pointClickable:!1,clusterClickable:!1,breakValues:[5,10,20],breakShapeSizes:[24,32,40,48],breakFillColors:["#71e28c","#58d7dd","#efcd45","#ff936a"],breakFillOpacities:[1,1,1,1],breakOutlines:[!0,!0,!0,!0],breakOutlineColors:["#71e28c","#58d7dd","#efcd45","#ff936a"],breakOutlineOpacities:[.6,.6,.6,.6],breakOutlineWidths:[12,16,20,24],breakTextSizes:[16,18,20,24],breakTextColors:["#fff","#fff","#fff","#fff"]},init:function(e){var r=this;r.options=G.Util.merge({},r.options,e),G.Layer.Graphic.prototype.init.call(r,e),r._zoom=0,r._showRelZoom=0,r._clusteredTrees=[],r._unclusteredTrees=[],r._spiderCluster=null},count:function(){var e,r,t=this,o=t._clusteredTrees[0],i=t._unclusteredTrees[0],n=i.count(),s=o.all();for(e in s)r=s[e],n+=r.count();return n},addPoint:function(e,r){var t=this;if(e instanceof G.Graphic.Point){e.addTo(t);var o,i,n,s,l,a,c,_,u,d=e._id,h=t.options,p={clickable:h.clickable},m=h.radius,f=h.zoomReses,g=e.geom,v=t._clusteredTrees,b=t._unclusteredTrees;for(o=t._showRelZoom;o>=0;o--){if(i=f[o]*m,n=t._searchNearest(v[o],g,i))return n._addChild(e),d;if(s=t._searchNearest(b[o],g,i)){for(c=o;c>=0;c--)b[c].remove(s.bbox,s);for(l=s._group,l&&l._removeChild(s),a=new G.Graphic.Cluster(null,o,v[o],p),a.addTo(t),u=[a],c=o-1;c>=0;c--){if(_=t._searchNearest(v[c],s.geom,f[c]*m),_&&(_._group||0==c)){u.push(_);break}_=new G.Graphic.Cluster(null,c,v[c],p),_.addTo(t),u.push(_)}for(c=0;c<u.length-1;c++)u[c]._group||u[c+1]._addChild(u[c]);return a._addChild(s),a._addChild(e),d}b[o].insert(e.bbox,e)}return d}},removePoint:function(e,r){var t=this,o=t._dataPoints[e];return delete t._dataPoints[e],t._tree.remove(o.bbox,o),r&&t._draw(),t},clear:function(){var e=this,r=e._map;e._graphics={},e._tree.clear(),delete e._hitGraphic;var t,o;for(t=0,o=e._clusteredTrees.length;t<o;t++)e._clusteredTrees[t].clear();for(t=0,o=e._unclusteredTrees.length;t<o;t++)e._unclusteredTrees[t].clear();return e._onClear(),r&&r._requestRedraw(),e},diveIn:function(e){var r=this,t=r._map,o=e.geom,i=e.getNextZoom(),n=r.options.zoomReses[i],s=t._size,l=s[0]*n,a=s[1]*n;return t.zoomTo(o,l,a),r},_onAdded:function(){var e=this,r=e._map,t=e.options;e._container||e._initContainer(),e.options.zoomReses=r._zoomReses;var o,i,n=t.zoomReses,s=n.length-1,l=t.showRealRes||n[s];for(o=0;o<s&&(i=n[o],!(i<l));o++)e._clusteredTrees[o]=new G.RTree,e._unclusteredTrees[o]=new G.RTree,e._showRelZoom=o;e.addListener("graphicClicked",e._onGraphicClicked),e.addListener("graphicOver",e._onGraphicOver),e.addListener("graphicOut",e._onGraphicOut),r.addListener("click",e._onClick,e),r.addListener("mousemove",e._onMouseMove,e)},_onRemoved:function(){var e=this,r=e._map;e._container&&e._destroyContainer(),e.removeListener("graphicClicked",e._onGraphicClicked),e.removeListener("graphicOver",e._onGraphicOver),e.removeListener("graphicOut",e._onGraphicOut),r.removeListener("click",e._onClick,e),r.removeListener("mousemove",e._onMouseMove,e)},_searchNearest:function(e,r,t){var o=this,i=r[0],n=r[1],s=[i-t,n-t,i+t,n+t],l=e.search(s);return o._getNearest(l,r,t)},_getNearest:function(e,r,t){if(e){var o,i,n,s,l,a=this,c=t*t;for(i in e)n=e[i],s=n.geom,l=a._sqrDis(s,r),l<c&&(o=n,c=l);return o}},_sqrDis:function(e,r){var t=e[0]-r[0],o=e[1]-r[1];return t*t+o*o},_onGraphicClicked:function(e){var r=this,t=e.graphic,o=t._parentGraphic;o&&o instanceof G.Graphic.Cluster&&r.fireEvent("clusterClicked",{cluster:o})},_onGraphicOver:function(e){var r=this,t=e.graphic,o=t._parentGraphic;o&&o instanceof G.Graphic.Cluster&&r.fireEvent("clusterOver",{cluster:o})},_onGraphicOut:function(e){var r=this,t=e.graphic,o=t._parentGraphic;o&&o instanceof G.Graphic.Cluster&&r.fireEvent("clusterOut",{cluster:o})},_draw:function(){var e=this,r=e._map;"canvas"==r._mode?e._drawCanvas():"svg"==r._mode?e._drawSvg():"vml"==r._mode&&e._drawVml()},_drawCanvas:function(){var e=this,r=e._map,t=e._ctx=r._useOffScreen?r._offScreenCtx:r._onScreenCtx;t.save();var o=r.getCenter(),i=r._res,n=r.getDrawSize(),s=n[0],l=n[1],a=o[0]-s*i/2,c=o[0]+s*i/2,_=o[1]-l*i/2,u=o[1]+l*i/2,d=[a,_,c,u],h=r.options.maxExtent,p=G.ExtentUtil.intersect(d,h),m=e._calcNearestZoom(),f=e._clusteredTrees[m],g=e._unclusteredTrees[m];e._showRelZoom&&m>=e._showRelZoom&&(f=null,g=e._tree);var v,b,C,x,k,y,T,w;w=e._tree.search(p);for(v in w)b=w[v],b.options.clickable=!1;for(k=0,y=e._clusteredTrees.length;k<y;k++){T=e._clusteredTrees[k].search(p);for(v in T)C=T[v],C._offClickable()}for(k=0,y=e._unclusteredTrees.length;k<y;k++){w=e._unclusteredTrees[k].search(p);for(v in w)b=w[v],b.options.clickable=!1}if(f){T=f.search(p).sort(e._sortIndex);for(v in T)C=T[v],C._onClickable(),x=C.bbox,C._draw&&C._layer&&G.ExtentUtil.overlaps(x,p)&&C._draw()}w=g.search(p).sort(e._sortIndex);for(v in w)b=w[v],b._parentGraphic||(b.options.clickable=e.options.pointClickable,x=b.bbox,b._draw&&b._layer&&G.ExtentUtil.overlaps(x,p)&&b._draw());t.restore(),e._zoom=m},_drawSvg:function(){var e=this,r=e._map,t=G.DomUtil,o=e._svg,i=t.getPosition(r._mapFrame),n=r.getSize(),s=r.getDrawSize(),l=s[0],a=s[1],c=(l-n[0])/2,_=(a-n[1])/2;t.setZIndex(e._container,e._zIndex),t.show(o),o.style[t.Transform]=t.genTranslateStyle(-c,-_),o.setAttribute("width",l),o.setAttribute("height",a),o.setAttribute("viewBox",[-i[0],-i[1],l,a].join(" "));var u=r.getCenter(),d=r._res,h=u[0]-l*d/2,p=u[0]+l*d/2,m=u[1]-a*d/2,f=u[1]+a*d/2,g=[h,m,p,f],v=r.options.maxExtent,b=G.ExtentUtil.intersect(g,v),C=e._calcNearestZoom(),x=e._clusteredTrees[C],k=e._unclusteredTrees[C];e._showRelZoom&&C>=e._showRelZoom&&(x=null,k=e._tree);var y,T,w,z,O,L,S,R;R=e._tree.all();for(y in R)T=R[y],T._updateDomViz(!1);for(O=0,L=e._clusteredTrees.length;O<L;O++){S=e._clusteredTrees[O].all();for(y in S)w=S[y],T._updateDomViz(!1)}for(O=0,L=e._unclusteredTrees.length;O<L;O++){R=e._unclusteredTrees[O].all();for(y in R)T=R[y],T._updateDomViz(!1)}if(x){S=x.search(b).sort(e._sortIndex);for(y in S)w=S[y],w._onClickable(),z=w.bbox,w._layer&&G.ExtentUtil.overlaps(z,b)&&(w._updatePoints(!0),w._updateStyles(),w._updateDomViz(!0))}R=k.search(b).sort(e._sortIndex);for(y in R)T=R[y],T._parentGraphic||(T.options.clickable=e.options.pointClickable,z=T.bbox,T._layer&&G.ExtentUtil.overlaps(z,b)&&(T._updatePoints(!0),T._updateStyles(),T._updateDomViz(!0)));e._zoom=C},_drawVml:function(){var e=this,r=e._map,t=G.DomUtil,o=r.getDrawSize(),i=o[0],n=o[1],s=e._vml;t.setZIndex(e._container,e._zIndex),t.show(s),s.style.width=i,s.style.height=n,s.coordsize=[i,n].join(" ");var l=r.getCenter(),a=r._res,c=l[0]-i*a/2,_=l[0]+i*a/2,u=l[1]-n*a/2,d=l[1]+n*a/2,h=[c,u,_,d],p=r.options.maxExtent,m=G.ExtentUtil.intersect(h,p),f=e._calcNearestZoom(),g=e._clusteredTrees[f],v=e._unclusteredTrees[f];e._showRelZoom&&f>=e._showRelZoom&&(g=null,v=e._tree);var b,C,x,k,y,T,w,z;z=e._tree.all();for(b in z)C=z[b],C._updateDomViz(!1);for(y=0,T=e._clusteredTrees.length;y<T;y++){w=e._clusteredTrees[y].all();for(b in w)x=w[b],C._updateDomViz(!1)}for(y=0,T=e._unclusteredTrees.length;y<T;y++){z=e._unclusteredTrees[y].all();for(b in z)C=z[b],C._updateDomViz(!1)}if(g){w=g.search(m).sort(e._sortIndex);for(b in w)x=w[b],x._onClickable(),k=x.bbox,x._layer&&G.ExtentUtil.overlaps(k,m)&&(x._updatePoints(!0),x._updateStyles(),x._updateDomViz(!0))}z=v.search(m).sort(e._sortIndex);for(b in z)C=z[b],C._parentGraphic||(C.options.clickable=e.options.pointClickable,k=C.bbox,C._layer&&G.ExtentUtil.overlaps(k,m)&&(C._updatePoints(!0),C._updateStyles(),C._updateDomViz(!0)));e._zoom=f}});