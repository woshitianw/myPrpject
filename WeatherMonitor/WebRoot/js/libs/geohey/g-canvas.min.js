G.Layer.Graphic=G.Layer.Graphic.extend({_update:function(){var e=this;e._draw()},_draw:function(){var e=this,t=e._map,a=e._ctx=t._useOffScreen?t._offScreenCtx:t._onScreenCtx;a.save();var r,i,o=t.getRedrawExtent(),n=e._tree.search(o).sort(e._sortIndex);for(var l in n)r=n[l],i=r.bbox,r._layer&&G.ExtentUtil.overlaps(i,o)&&r._draw();a.restore()}}),G.Layer.Html=G.Layer.Html.extend({_placeHtml:function(e){var t=this,a=(G.MathUtil,G.Browser.getPxRatio()),r=(a[0],a[1],t._map),i=(r._rotate,r._res,t.options,G.DomUtil),o=t._zoomScale||t._scale,n=t._aroundScreen,l=r.toScreen(e.geom,n,o),s=l[0],_=l[1];t._hidden?i.hide(e):i.show(e),i.markPosTransform(e,s,_),i.updateTransform(e)},_onZoom:function(){var e=this,t=e._map;t._rotate,G.DomUtil;if(e._zooming)return e._tempScale==e._latestTempScale?void e._erase():void(e._latestTempScale=e._tempScale)},_onRotate:function(){var e=this;e._draw()},_onPinch:function(){var e=this;e._draw()}}),G.Layer.Image=G.Layer.Image.extend({_initContainer:function(){var e=this,t=e._map;e.addListener("imageSuccess",t._requestRedraw,t)},_destroyContainer:function(){var e=this,t=e._map;e.removeListener("imageSuccess",t._requestRedraw,t)},_update:function(){var e=this,t=e._map;t._isLoaded()&&e._draw()},_draw:function(){var e,t,a=this,r=a._map,i=a.options,o=a._ctx=r._useOffScreen?r._offScreenCtx:r._onScreenCtx,n=i.opacity<1;n&&(o.save(),o.globalAlpha=i.opacity);for(t in a._images)e=a._images[t],e._loaded&&a._placeImage(e);n&&o.restore()},_placeImage:function(e){if(e._loaded){var t=this,a=G.MathUtil,r=G.Browser.getPxRatio(),i=r[0],o=r[1],n=t._map,l=n._res,s=n._rotate,_=e.bbox,c=_[0],d=_[1],f=t._zoomScale||t._scale,u=t._aroundScreen,g=(_[2]-_[0])/l,v=(_[3]-_[1])/l;f&&1!==f&&(g/=f,v/=f);var h=n.toScreen([c,d],u,f),m=h[0],p=h[1],y=n._canvasOffset;m+=y[0],p+=y[1];var x=t._ctx;s&&(x.save(),x.translate(m,p),x.rotate(s/a.DEGREE_PER_RADIAN),x.translate(-m,-p));try{x.drawImage(e,m,p-v/o,g/i,v/o)}catch(C){}s&&x.restore()}},_onZoomStart:function(){},_onZoomUpdate:function(){},_onZoomEnd:function(){}}),G.Layer.Tile=G.Layer.Tile.extend({canvasFilter:{filters:["gray","dark","negative"],gray:function(e){for(var t=0,a=e.length;t<a;t+=4){var r=(e[t]+e[t+1]+e[t+2])/3;e[t]=e[t+1]=e[t+2]=r}},dark:function(e){for(var t=0,a=e.length;t<a;t+=4){var r=(e[t]+e[t+1]+e[t+2])/3;e[t]=e[t+1]=e[t+2]=255-r}},negative:function(e){for(var t=0,a=e.length;t<a;t+=4)e[t]=255-e[t],e[t+1]=255-e[t+1],e[t+2]=255-e[t+2]}},_initContainer:function(){var e=this,t=e._map;e.addListener("tileSuccess",t._requestRedraw,t),e.addListener("allLoaded",t._requestRedraw,t)},_destroyContainer:function(){var e=this,t=e._map;e.removeListener("tileSuccess",t._requestRedraw,t),e.removeListener("allLoaded",t._requestRedraw,t)},_update:function(){var e=this,t=e._map;if(t._isLoaded()){var a,r,i,o,n,l,s,_,c,d,f,u=e._zoom=e._calcNearestZoom(!0),g=e._calcVisTileInfos(!0),v=(t.getSize(),t.getCenter()),h=e.options,m=h.zoomReses[u],p=h.tileSize,y=t.getDrawSize(),x=1+2*t.options.canvasExpandFactor,C=y[0]*x,S=y[1]*x,w=v[0]-C*m/2,D=v[0]+C*m/2,O=v[1]-S*m/2,E=v[1]+S*m/2,R=[w,O,D,E],L=t.options.maxExtent,P=h.filter=G.Util.trim(e.options.filter),b=e.canvasFilter.filters;e._redrawExtent=R;var M=G.ExtentUtil.intersect(R,L);P&&b.indexOf(P)<0&&(h.filter="",console.log("滤镜参数错误"));for(var T in e._tiles)i=e._tiles[T],o=i._info,a=o[0],r=o[1],n=o[2],f=h.zoomReses[n],n!==u&&(e._stopLoadingTile(i),(!h.keepResample||h.opacity<1)&&e._removeTile(T)),l=h.originX+a*p*f,s=h.originX+(a+1)*p*f,_=h.originY-(r+1)*p*f,c=h.originY-r*p*f,d=G.ExtentUtil.overlaps([l,_,s,c],M),d||e._tileInfoExist(o,g)||e._removeTile(T);var I=e._calcTileIndex(v[0],v[1],u);e._sortTileInfos(g,I[0],I[1]),e._addTiles(g),e._draw()}},_draw:function(){var e,t,a,r,i,o,n=this,l=n._map,s=n.options,_=n._ctx=l._useOffScreen?l._offScreenCtx:l._onScreenCtx,c=n._zoom,d=s.opacity<1;d&&(_.save(),_.globalAlpha=s.opacity);for(o in n._tiles)e=n._tiles[o],t=e._info,i=parseInt(t[2]),!e._loaded||i===c||!s.keepResample||s.opacity<1||(a=parseInt(t[0]),r=parseInt(t[1]),n._placeTile(e,a,r,i));for(o in n._tiles)e=n._tiles[o],t=e._info,i=parseInt(t[2]),e._loaded&&i===c&&(a=parseInt(t[0]),r=parseInt(t[1]),n._placeTile(e,a,r,i));d&&_.restore()},_placeTile:function(e,t,a,r){if(e._loaded){var i=Math.round,o=this,n=G.MathUtil,l=G.Browser.getPxRatio(),s=l[0],_=l[1],c=o._map,d=c._rotate,f=c._res,u=o.options,g=c.options,v=u.tileSize,h=u.zoomReses[r],m=v*h,p=u.tileEnlarge&&(!!(d%90)||G.Browser.gecko||G.Browser.safari),y=u.filter,x=(o.canvasFilter.filters,Math.ceil(m/f)+(p?2:0)),C=u.originX+t*m,S=u.originY-a*m,w=o._zoomScale||o._scale,D=o._aroundScreen;if(w&&1!==w&&(x/=w),!(x>4*(v+2)||x<v/8)){var O=0,E=0,R=g.maxExtent,L=R[2]-R[0];if(g.wrap){var P=o._redrawExtent;P&&R&&(E=Math.floor((P[0]-u.minX)/L)-1,O=Math.ceil((P[2]-u.maxX)/L)+1)}for(var b=E;b<=O;b++){var M=C+b*L,T=S,I=c.toScreen([M,T],D,w),U=I[0],A=I[1],W=c._canvasOffset;U+=W[0],A+=W[1],p&&(U-=1,A-=1),U=i(U),A=i(A);var k=o._ctx;d&&(k.save(),k.translate(U,A),k.rotate(d/n.DEGREE_PER_RADIAN),k.translate(-U,-A));try{var F=y?e._canvas:e;k.drawImage(F,U,A,i(x/s),i(x/_))}catch(N){}d&&k.restore()}}}},_addTiles:function(e){var t=this;if(0!==e.length){t._numLoad=e.length,t._numLoadSuccess=0,t._numLoadError=0;for(var a,r,i,o,n,l,s,_=t.options,c=(_.zoomReses.length,t.options.errorTileUrl||G.Layer.Tile.EMPTY_TILE),d=0,f=e.length;d<f;d++)r=e[d],i=r[0],o=r[1],n=r[2],s=_.zoomReses[n],l=t._getTileName(i,o,n),a=t._tiles[l],a?a.src==c?+new Date-a._responseTime>_.tileLiveMs&&t._loadTile(a,i,o,n):t._numLoadSuccess++:(a=t._getIdleTile(),t._tiles[l]=a,t._loadTile(a,i,o,n));t._checkAllHandled()}},_onTileLoad:function(e){var t=e._layer;e._responseTime=+new Date;var a=t.options.errorTileUrl||G.Layer.Tile.EMPTY_TILE;if(e.src!==a){if("naturalWidth"in e&&!e.naturalWidth){var r=e.src;e.src=a,t._numLoadError++,t.fireEvent("tileError",{tile:e,url:r})}else{G.DomUtil.addClass(e,"g-tile-loaded"),e._loaded=!0;var i=this.options.filter;if(i){var o=G.DomUtil.create("canvas"),n=o.getContext("2d"),l=G.Browser.getCanvasRatio(),s=o.width=256*l[0],_=o.height=256*l[1];n.drawImage(e,0,0,s,_);var c=n.getImageData(0,0,s,_),d=c.data;this.canvasFilter[i](d),n.putImageData(c,0,0),e._canvas=n.canvas}t._numLoadSuccess++,t.fireEvent("tileSuccess",{tile:e,url:e.src})}t._checkAllHandled()}},_clearBgBuffer:function(){var e,t,a,r=this;for(var i in r._tiles)e=r._tiles[i],t=e._info,a=t[2],a!==r._zoom&&r._removeTile(i)}}),G.Layer.Label=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{icons:"",cluster:[],crossOrigin:"*"},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.url=e,a.options=G.Util.merge({},a.options,t),a._lts={},a._gx=a._gy=10},_initContainer:function(){var e=this;G.Layer.Graphic.prototype._initContainer.call(e)},_onAdded:function(){var e=this;e._container||e._initContainer()},_onRemoved:function(){var e=this;e._container&&e._destroyContainer()},_update:function(){var e=this,t=e._map;if(G.Layer.Graphic.prototype._update.call(e),t._isLoaded()){var a=e._zoom=e._calcNearestZoom(!0),r=t.getCenter();e._clearGrids();var i=t._zoomAnim;if(i&&i._playing);else{var o=e._calcVisTileInfos(),n=e._calcTileIndex(r[0],r[1],a);e._sortTileInfos(o,n[0],n[1]),e._setLts(o)}}},_setLts:function(e){var t=this;if(e.length){for(var a,r,i,o,n,l,s=[],_=0,c=e.length;_<c;_++)i=e[_],o=i[0],n=i[1],l=i[2],a=t._getTileName(o,n,l),s.push(a),a in t._lts?(r=t._lts[a],r.loading||r.data||r.ri||t._loadLtI(o,n,l)):t._loadLtI(o,n,l),t._placeLt(a);t._dirtyTileKeys=t._dirtyTileKeys||[];for(a in t._lts)s.indexOf(a)>-1||(t._stopLoadingLt(a),t._dirtyTileKeys.push(a))}},_checkDirtyTiles:function(){var e,t=this,a=t._dirtyTileKeys;if(a&&a.length>0)for(var r=0,i=a.length;r<i;r++)e=a[r],t._removeLt(e);t._dirtyTileKeys=[]},_placeLt:function(e){var t=this,a=t._lts[e];if(a&&a._info&&a.data){var r,i,o,n,l,s,_,c,d,f,u,g,v,h,m,p,y,x,C,S,w=a.data.l;for(r in w){i=w[r],o=Number(i[0]),n=Number(i[1]),l=Number(i[2]),s=Number(i[3]),_=Number(i[4]),c=Number(i[5]),d=i[6],p=[o,n],y="imgs"+r,x=a[y];for(C in x)f=x[C],u=f[0],g=f[1],v=f[2],h=f[3],m=f[4],S=f[5],S||(f[5]=S=new G.Graphic.Point(p,null,{shape:"image",size:[g,v],offset:[h,m],image:u,imageGravity:!!d}),S.addTo(t))}}},_removeLt:function(e){var t=this,a=t._lts[e];if(a&&a._info&&a.data){t._stopLoadingLt(e);var r,i,o,n,l,s=a.data.l;for(r in s){o="imgs"+r,n=a[o];for(l in n)i=n[l],g=i[5],g&&g.remove()}delete t._lts[e]}},_loadLtI:function(e,t,a){var r=this,i=r._getTileName(e,t,a),o=r._lts[i]=r._lts[i]||{};if(o._info=[e,t,a],""!==o.data){o.loading=!0;var n=r._getTileUrl(e,t,a,{d:"i",i:G.Browser.retina?"@2x":""}),l={};r.options.crossOrigin&&(l.crossOrigin=r.options.crossOrigin);var s={responseType:"http"===n.slice(0,4).toLowerCase()?"JSONP":"JSON",header:l,success:function(e,t){o.data=t,r._processLt(i)},error:function(e){404==e.status&&(o.data="")},complete:function(){delete o.ri,o.loading=!1}};r.options.crossOrigin&&(s.responseType="JSON");var _=G.Util.ajax(n,s);o.ri=_}},_processLt:function(e){var t=this,a=t._lts[e],r=a.data;if(r){var i,o,n,l,s,_,c,d,f,u,g,v,h,m,p,y,x,G,C,S,w,D=r.l,O=r.b,E=r.i,R=r.bb,L=t.options.icons||"";for(o in D){if(i=D[o],n=Number(i[0]),l=Number(i[1]),s=i[6],O&&o in O)for(h=O[o],S=0,w=h.length;S<w;S++)m=h[S],_=m[0],c=m[1],d=m[2],f=m[3],u=m[4],g=m[5],0!=g&&R&&(x=R.slice(u,u+g),G="data:image/png;base64,"+x,C="b"+S,a["imgs"+o]=a["imgs"+o]||{},a["imgs"+o][C]=[G,_,c,d,f]);if(E&&o in E)for(p=E[o],S=0,w=p.length;S<w;S++)y=p[S],_=y[0],c=y[1],d=y[2],f=y[3],v=y[4],G=L+v,C="i"+S,a["imgs"+o]=a["imgs"+o]||{},a["imgs"+o][C]=[G,_,c,d,f]}t._checkDirtyTiles(),t._placeLt(e)}},_stopLoadingLt:function(e){var t=this._lts[e],a=G.Util.ajaxCancel;t&&(a(t.ri),t.loading=!1)},_onIconLoad:function(){this._dirtyIcons=!0},_clearGrids:function(){this._g={}},_hitGrids:function(e,t,a,r){for(var i,o=this,n=e;n<=a;n++)for(var l=t;l<=r;l++)if(i=n+","+l,o._g[i])return!0;return!1},_markGrids:function(e,t,a,r){for(var i,o=this,n=e;n<=a;n++)for(var l=t;l<=r;l++)i=n+","+l,o._g[i]=!0}}),G.Layer.FeatureService=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{mode:"all",vacuumCount:1e3},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.options=G.Util.merge({},a.options,t),a._reqFunc=e,a._loadingKeys={}},onSuccess:function(e){var t=this;"tile"==t.options.mode?t.fireEvent("loadTileSuccess",{extent:e}):t.fireEvent("loadAllSuccess")},onError:function(e){var t=this;"tile"==t.options.mode?t.fireEvent("loadTileError",{extent:e}):t.fireEvent("loadAllError")},onComplete:function(e){var t=this;if("tile"==t.options.mode){var a=e.join(",");delete t._loadingKeys[a],t.fireEvent("loadTileComplete",{extent:e})}else t.fireEvent("loadAllComplete")},_update:function(){var e=this,t=e._map;if(G.Layer.Graphic.prototype._update.call(e),t._isLoaded())if("tile"==e.options.mode){var a=e.count();a>e.options.vacuumCount&&e._vacuum();var r=e._calcVisTileInfos();e._addFts(r)}else e._loadAll()},_addFts:function(e){var t=this;if(0!==e.length){var a,r,i,o,n,l,s,_,c,d=t._loadingKeys,f={};for(a=0,r=e.length;a<r;a++)n=e[a],l=n[0],s=n[1],_=n[2],c=t._calcTileExtent(l,s,_),i=c.join(","),f[i]=c;for(i in d)f[i]||(o=d[i],G.Util.ajaxCancel(o),delete d[i]);for(i in f)c=f[i],t._loadFt(c)}},_loadFt:function(e){var t=this,a=e.join(","),r=t._reqFunc;if(!(a in t._loadingKeys)&&r){var i=r.call(t,e);t._loadingKeys[a]=i,t.fireEvent("loadTileStart",{extent:e})}},_loadAll:function(){var e=this,t="all",a=e._reqFunc;if(!(t in e._loadingKeys)&&a){var r=a.call(e);e._loadingKeys[t]=r,e.fireEvent("loadAllStart")}}}),G.Layer.GeoHeyFeature=G.Layer.FeatureService.extend({options:{apiKey:"",where:"1=1",outFields:"",limit:1e3},init:function(e,t){var a=this,r=function(t){var r=e+"/query",i=a.options,o={ak:i.apiKey,where:i.where,outFields:i.outFields,limit:i.limit};t&&(o.geometry=JSON.stringify(t));var n={responseType:"http"===r.slice(0,4).toLowerCase()?"JSONP":"JSON",data:o,success:function(e,r){var o=r.data,n=o.geometryType,l=o.features;if(l){var s,_,c,d,f,u,g,v,h=l.length-1,m=Math.max(0,h-i.limit),p=[];for(s=h;s>=m;s--){_=l[s],c=_.id,d=_.geom,f=_.attrs||{},"Point"==n?p.push(new G.Graphic.Point(d,f)):"Polyline"==n?p.push(new G.Graphic.Polyline(d,f)):"Polygon"==n?p.push(new G.Graphic.Polygon(d,f)):"MultiPoint"==n?p.push(new G.Graphic.MultiPoint(d,f)):"MultiPolyline"==n?p.push(new G.Graphic.MultiPolyline(d,f)):"MultiPolygon"==n&&p.push(new G.Graphic.MultiPolygon(d,f));for(g in p)v=p[g],v&&(u=c+"_"+g,a.get(u)||v.addTo(a,u))}}a.onSuccess(t)},error:function(){a.onError(t)},complete:function(){a.onComplete(t)}};G.Util.ajax(r,n)};G.Layer.FeatureService.prototype.init.call(a,r,t)}}),G.Layer.GeoHeyProgressiveFeature=G.Layer.Graphic.extend({options:{stepFactor:4,stepCount:4,tolerance:8,outFields:"[]"},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.url=e},onSuccess:function(e){this.fireEvent("extentSuccess",{extent:e})},onError:function(e){this.fireEvent("extentError",{extent:e})},onComplete:function(e){var t=this;t.fireEvent("extentComplete",{extent:e})},_update:function(){var e=this,t=e._map,a=e._loadRes=t._res,r=e._loadExtent=t.getExtent(),i=e._loadedStatus;if((!i||a!=i[0]||!G.ExtentUtil.equals(r,i[1]))&&(G.Layer.Graphic.prototype._update.call(e),t._isLoaded())){var o=e._req;o&&G.Util.ajaxCancel(o);var n,l,s=e._graphics;for(l in s)n=s[l],n._dirty=!0;e._loadStep(1)}},_loadStep:function(e){var t=this,a=t.options,r=t._loadRes,i=t._loadExtent,o=a.tolerance*Math.pow(a.stepFactor,a.stepCount-e),n=t.url+"/filter",l={responseType:"JSON",data:{extent:JSON.stringify(i),excludeExtents:JSON.stringify([]),res:r,cellPixel:o,outFields:a.outFields},success:function(a,r){t._processResult(e,r)},complete:function(){t._req=null}};t._req=G.Util.ajax(n,l)},_processResult:function(e,t){var a=this,r=a.options,i=a._loadRes,o=a._loadExtent,n=r.tolerance*Math.pow(r.stepFactor,r.stepCount-e),l=i*n,s=t.geometryType,_=t.features;if(!_)return a.onError(o),void a.onComplete(o);var c,d,f,u,g,v,h,m,p=_.length-1;for(c=p;c>=0;c--)if(d=_[c],f=d.id,u=d.geom,g=d.attrs||{},"Point"==s)m=new G.Graphic.Point(u,g),a._updateGraphic(l,f,0,m);else if("Polyline"==s)m=new G.Graphic.Polyline(u,g),a._updateGraphic(l,f,0,m);else if("Polygon"==s)m=new G.Graphic.Polygon(u,g),a._updateGraphic(l,f,0,m);else if("MultiPoint"==s)for(v in u.multi)h=u.multi[v],m=new G.Graphic.Point(h,g),a._updateGraphic(l,f,v,m);else if("MultiPolyline"==s)for(v in u.multi)h=u.multi[v],m=new G.Graphic.Polyline(h,g),a._updateGraphic(l,f,v,m);else if("MultiPolygon"==s)for(v in u.multi)h=u.multi[v],m=new G.Graphic.Polygon(h,g),a._updateGraphic(l,f,v,m);e<r.stepCount?a._loadStep(e+1):(a._clearDirty(),a._loadedStatus=[i,o],a.onSuccess(o),a.onComplete(o))},_updateGraphic:function(e,t,a,r){var i=this,o=t+(a?"_"+a:""),n=i.get(o);n?(e<n._res&&(n.updateGeom(r.geom,!0),n._res=e),n._dirty=!1):(r._res=e,r.addTo(i,o))},_clearDirty:function(){var e,t,a=this,r=a._graphics;for(t in r)e=r[t],e._dirty&&e.remove()}}),G.Layer.TiledService=G.Layer.extend({mixins:[G.Layer.LOD],init:function(e,t){var a=this;a.options=G.Util.merge({},a.options,t),a._reqFunc=e,a._loadingKeys={},a._loadedKeys={}},onSuccess:function(e,t){var a=this;a._numLoadSuccess++;var r=parseInt(e[0]),i=parseInt(e[1]),o=parseInt(e[2]),n=a._getTileName(r,i,o);a._loadedKeys[n]=e,a.fireEvent("loadTileSuccess",{tileInfo:e,data:t})},onError:function(e){var t=this;t._numLoadError++,t.fireEvent("loadTileError",{tileInfo:e})},onComplete:function(e){var t=this,a=parseInt(e[0]),r=parseInt(e[1]),i=parseInt(e[2]),o=t._getTileName(a,r,i);delete t._loadingKeys[o],t.fireEvent("loadTileComplete",{tileInfo:e}),t._checkAllHandled()},_update:function(){var e=this,t=e._map;if(t._isLoaded()){var a,r,i,o,n,l,s,_=e._calcVisTileInfos(),c={};for(a=0,r=_.length;a<r;a++)o=_[a],n=o[0],l=o[1],s=o[2],i=e._getTileName(n,l,s),c[i]=o;e._addTiles(c);for(i in e._loadedKeys)c[i]||(o=e._loadedKeys[i],delete e._loadedKeys[i],e.fireEvent("unusedTile",{tileInfo:o}));e._onUpdated()}},_addTiles:function(e){var t,a,r,i=this,o=i._loadingKeys;for(t in o)e[t]||(a=o[t],G.Util.ajaxCancel(a),delete o[t]);i._numLoad=Object.keys(e).length,i._numLoadSuccess=0,i._numLoadError=0;for(t in e)r=e[t],i._loadTile(r);i._checkAllHandled()},_loadTile:function(e){var t=this,a=t._reqFunc,r=parseInt(e[0]),i=parseInt(e[1]),o=parseInt(e[2]),n=t._getTileName(r,i,o);if(!(n in t._loadingKeys)&&a){if(n in t._loadedKeys)return void t._numLoadSuccess++;var l=a.call(t,r,i,o);t._loadingKeys[n]=l,t.fireEvent("loadTileStart",{tileInfo:e})}},_stopLoadingByKey:function(e){var t=this._loadingKeys,a=t[e];a&&(G.Util.ajaxCancel(a),delete t[e])},_checkAllHandled:function(){var e=this;e._numLoad==e._numLoadSuccess+e._numLoadError&&e.fireEvent("allLoaded")},_onUpdated:function(){}}),G.Graphic.Arrow=G.Graphic.Arrow.extend({_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx;e._updateGeomDraw(r._res);var o,n,l,s=e._geomDraw,_=r._canvasOffset,c=e.bbox,d=(c[0]+c[2])/2,f=(c[1]+c[3])/2,u=r._calcWrapPointRange([d,f])||[0,0],g=r.options.maxExtent,v=g[2]-g[0];i.save();for(var h=u[0];h<=u[1];h++){i.beginPath();for(var m=0,p=s.length;m<p;m++){n=s[m];for(var y=0,x=n.length;y<x;y++)l=n[y],l=r.toScreen([l[0]+h*v,l[1]]),o=0===y?"moveTo":"lineTo",i[o](l[0]+_[0],l[1]+_[1]);l=n[0],l=r.toScreen([l[0]+h*v,l[1]]),i.lineTo(l[0]+_[0],l[1]+_[1])}if(t.fill){if(t.fillImage){var C=G.Browser.getImageSrc(t.fillImage),S=G.DomUtil.getImgElement(C,function(){r._requestRedraw()},null,"*");S._loaded?(i.fillStyle=i.createPattern(S,"repeat"),i.globalAlpha=t.fillOpacity):i.globalAlpha=0}else i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity;i.fill()}(t.outline||e._mouseOver||e._editing)&&(i.strokeStyle=e._editing?t.lineHighlightColor:t.outline?t.outlineColor:t.fillColor,i.lineCap=t.outlineCap,i.lineJoin=t.outlineJoin,i.lineWidth=(t.outline?t.outlineWidth:0)+(e._mouseOver?t.lineHighlightWiden:0),i.globalAlpha=t.outlineOpacity,G.Util.setCanvasLineDash(i,t.outlineDashArray),i.stroke())}i.restore()},_drawMask:function(){var e=this,t=e._map,a=t._maskCtx;e._updateGeomDraw(t._res);var r,i,o,n=e._geomDraw,l=t._canvasOffset,s=e.bbox,_=(s[0]+s[2])/2,c=(s[1]+s[3])/2,d=t._calcWrapPointRange([_,c])||[0,0],f=t.options.maxExtent,u=f[2]-f[0];a.beginPath();for(var g=d[0];g<=d[1];g++)for(var v=0,h=n.length;v<h;v++){i=n[v];for(var m=0,p=i.length;m<p;m++)o=i[m],o=t.toScreen([o[0]+g*u,o[1]]),r=0===m?"moveTo":"lineTo",a[r](o[0]+l[0],o[1]+l[1]);o=i[0],o=t.toScreen([o[0]+g*u,o[1]]),a.lineTo(o[0]+l[0],o[1]+l[1])}a.fill()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Circle=G.Graphic.Circle.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=r._res,n=e.geom,l=n[0],s=n[1],_=n[2],c=_/o,d=r._canvasOffset,f=r._calcWrapPointRange(n)||[0,0],u=r.options.maxExtent,g=u[2]-u[0];i.save();for(var v=f[0];v<=f[1];v++){var h=r.toScreen([l+v*g,s]);if(h[0]+=d[0],h[1]+=d[1],i.beginPath(),i.arc(h[0],h[1],c,0,2*Math.PI),t.fill){if(t.fillImage){var m=G.Browser.getImageSrc(t.fillImage),p=G.DomUtil.getImgElement(m,function(){r._requestRedraw()},null,"*");p._loaded?(i.fillStyle=i.createPattern(p,"repeat"),i.globalAlpha=t.fillOpacity):i.globalAlpha=0}else if(t.gradual){var y=i.createRadialGradient(h[0],h[1],0,h[0],h[1],c),x=G.Util.colorRgb(t.fillColor);y.addColorStop(0,t.fillColor),y.addColorStop(1,"rgba("+x[0]+","+x[1]+","+x[2]+","+t.fillOpacity+")"),i.fillStyle=y}else i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity;i.fill()}(t.outline||e._mouseOver)&&(i.strokeStyle=e._editing?t.lineHighlightColor:t.outlineColor,i.lineWidth=e._mouseOver?t.outlineWidth+t.lineHighlightWiden:t.outlineWidth,i.globalAlpha=t.outlineOpacity,G.Util.setCanvasLineDash(i,t.outlineDashArray),i.stroke())}i.restore()},_drawMask:function(){var e=this,t=e._map,a=t._maskCtx,r=t._res,i=e.geom,o=i[0],n=i[1],l=i[2],s=l/r,_=t._canvasOffset,c=t._calcWrapPointRange(i)||[0,0],d=t.options.maxExtent,f=d[2]-d[0];a.beginPath();for(var u=c[0];u<=c[1];u++){var g=t.toScreen([o+u*f,n]);g[0]+=_[0],g[1]+=_[1],a.arc(g[0],g[1],s,0,2*Math.PI,!1)}a.fill()},_onStartEdit:function(){var e=this,t=e._layer,a=t._map,r=e.virtualMouse;for(var i in r.DOWN)a.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(var r in a.DOWN)t.removeListener(a.DOWN[r],e._onVertexDragStart,e);e._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Group=G.Graphic.Group.extend({_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.MultiPoint=G.Graphic.MultiPoint.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=Math.round,n=t.shape,l=t.size,s=l[0],_=l[1],c=t.offset,d=t.imageRotate;t.imageGravity||(d+=r._rotate),"image"==n&&d&&(c=G.MathUtil.rotateVector(c,d));for(var f,u,g,v=e.geom.m,h=r._canvasOffset,m=e.bbox,p=(m[0]+m[2])/2,y=(m[1]+m[3])/2,x=r._calcWrapPointRange([p,y])||[0,0],C=r.options.maxExtent,S=C[2]-C[0],w=x[0];w<=x[1];w++)for(var D=0;D<v.length;D++)if(f=v[D],f=r.toScreen([f[0]+w*S,f[1]]),u=f[0]+c[0]+h[0],g=f[1]+c[1]+h[1],"rect"==n)i.beginPath(),i.rect(u-s/2,g-_/2,s,_),e._renderPath(u,g,Math.max(s/2,_/2));else if("image"==n){var O=G.Browser.getImageSrc(t.image),E=G.DomUtil.getImgElement(O,function(){r._requestRedraw()});E._loaded&&(i.save(),i.translate(o(u),o(g)),i.rotate(d/G.MathUtil.DEGREE_PER_RADIAN),i.drawImage(E,0,0,s,_),i.restore())}else if("text"==n){i.save(),i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity,i.font=t.textStyle+" "+s+"px "+t.textFont,i.textAlign=t.textAlign,i.textBaseline="middle";var R=t.text;if(!e._textMeasureWidth||e._textMeasure!=R){var L=i.measureText(R);e._textMeasureWidth=L.width,e._textMeasure=R}i.fillText(R,u,g),i.restore()}else i.beginPath(),i.arc(u,g,s/2,0,2*Math.PI),e._renderPath(u,g,s/2)},_renderPath:function(e,t,a){var r,i,o=this,n=o._layer,l=n._map,s=n._ctx,_=o.options;if(s.save(),_.fill){if(_.fillImage)r=G.Browser.getimgSrc(_.fillImage),i=G.DomUtil.getImgElement(r,function(){l._requestRedraw()}),i._loaded?(s.fillStyle=s.createPattern(i,"repeat"),s.globalAlpha=_.fillOpacity):s.globalAlpha=0;else if(_.gradual){var c=s.createRadialGradient(e,t,0,e,t,a),d=G.Util.colorRgb(_.fillColor);c.addColorStop(0,_.fillColor),c.addColorStop(1,"rgba("+d[0]+","+d[1]+","+d[2]+","+_.fillOpacity+")"),s.fillStyle=c}else s.fillStyle=_.fillColor,s.globalAlpha=_.fillOpacity;s.fill()}(_.outline||o._mouseOver||o._editing)&&(s.strokeStyle=o._editing?_.lineHighlightColor:_.outline?_.outlineColor:_.fillColor,s.lineWidth=o._mouseOver?_.outlineWidth+_.lineHighlightWiden:_.outlineWidth,s.globalAlpha=_.outlineOpacity,G.Util.setCanvasLineDash(s,_.outlineDashArray),s.stroke()),s.restore()},_onStartEdit:function(){var e=this,t=e._layer,a=t._map,r=e.virtualMouse;for(var i in r.DOWN)a.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(var r in a.DOWN)t.removeListener(a.DOWN[r],e._onVertexDragStart,e);e._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging&&!e.options.allowPan,a._requestRedraw(),e._isVertex?r.addClass(a._layersFrame,"g-edit"):r.addClass(a._layersFrame,"g-clickable")}},_onMouseOut:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging,a._requestRedraw(),e._isVertex?r.removeClass(a._layersFrame,"g-edit"):r.removeClass(a._layersFrame,"g-clickable")}}}),G.Graphic.MultiPolygon=G.Graphic.MultiPolygon.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a,r,i=this,o=i.options,n=i._layer,l=n._map,s=n._ctx,_=i.geom.m,c=l._canvasOffset,d=i.bbox,f=(d[0]+d[2])/2,u=(d[1]+d[3])/2,g=l._calcWrapPointRange([f,u])||[0,0],v=l.options.maxExtent,h=v[2]-v[0];s.save(),s.beginPath();for(var m=g[0];m<=g[1];m++)for(var p=0,y=_.length;p<y;p++){e=_[p];for(var x=0,C=e.length;x<C;x++){a=e[x];for(var S=0,w=a.length;S<w;S++)r=a[S],r=l.toScreen([r[0]+m*h,r[1]]),t=0===S?"moveTo":"lineTo",s[t](r[0]+c[0],r[1]+c[1]);r=a[0],r=l.toScreen([r[0]+m*h,r[1]]),s.lineTo(r[0]+c[0],r[1]+c[1])}}if(o.fill){if(o.fillImage){var D=G.Browser.getImageSrc(o.fillImage),O=G.DomUtil.getImgElement(D,function(){l._requestRedraw()},null,"*");O._loaded?(s.fillStyle=s.createPattern(O,"repeat"),s.globalAlpha=o.fillOpacity):s.globalAlpha=0}else s.fillStyle=o.fillColor,s.globalAlpha=o.fillOpacity;s.fill()}(o.outline||i._mouseOver||i._editing)&&(s.strokeStyle=i._editing?o.lineHighlightColor:o.outline?o.outlineColor:o.fillColor,s.lineCap=o.outlineCap,s.lineJoin=o.outlineJoin,s.lineWidth=(o.outline?o.outlineWidth:0)+(i._mouseOver?o.lineHighlightWiden:0),s.globalAlpha=o.outlineOpacity,G.Util.setCanvasLineDash(s,o.outlineDashArray),s.stroke()),s.restore()},_drawMask:function(){var e,t,a,r,i=this,o=i._map,n=o._maskCtx,l=i.geom.m,s=o._canvasOffset,_=i.bbox,c=(_[0]+_[2])/2,d=(_[1]+_[3])/2,f=o._calcWrapPointRange([c,d])||[0,0],u=o.options.maxExtent,g=u[2]-u[0];n.beginPath();for(var v=f[0];v<=f[1];v++)for(var h=0,m=l.length;h<m;h++){e=l[h];for(var p=0,y=e.length;p<y;p++){a=e[p];for(var x=0,G=a.length;x<G;x++)r=a[x],r=o.toScreen([r[0]+v*g,r[1]]),t=0===x?"moveTo":"lineTo",n[t](r[0]+s[0],r[1]+s[1]);r=a[0],r=o.toScreen([r[0]+v*g,r[1]]),n.lineTo(r[0]+s[0],r[1]+s[1])}}n.fill()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.MultiPolyline=G.Graphic.MultiPolyline.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a,r=this,i=r.options,o=r._layer,n=o._map,l=o._ctx,s=r.geom.m,_=n._canvasOffset,c=r.bbox,d=(c[0]+c[2])/2,f=(c[1]+c[3])/2,u=n._calcWrapPointRange([d,f])||[0,0],g=n.options.maxExtent,v=g[2]-g[0];l.save(),l.beginPath();for(var h=u[0];h<=u[1];h++)for(var m=0,p=s.length;m<p;m++){e=s[m];for(var y=0,x=e.length;y<x;y++)a=e[y],a=n.toScreen([a[0]+h*v,a[1]]),t=0===y?"moveTo":"lineTo",l[t](a[0]+_[0],a[1]+_[1])}l.strokeStyle=r._editing?i.lineHighlightColor:i.lineColor,l.lineCap=i.lineCap,l.lineJoin=i.lineJoin,l.lineWidth=r._mouseOver?i.lineWidth+i.lineHighlightWiden:i.lineWidth,l.globalAlpha=i.lineOpacity,G.Util.setCanvasLineDash(l,i.lineDashArray),l.stroke(),l.restore()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Point=G.Graphic.Point.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=Math.round,n=t.shape,l=t.size,s=l[0],_=l[1],c=t.offset,d=t.imageRotate;t.imageGravity||(d+=r._rotate),"image"==n&&d&&(c=G.MathUtil.rotateVector(c,d));for(var f=e.geom[0],u=e.geom[1],g=r._canvasOffset,v=r._calcWrapPointRange(e.geom)||[0,0],h=r.options.maxExtent,m=h[2]-h[0],p=v[0];p<=v[1];p++){var y=r.toScreen([f+p*m,u]),x=y[0]+c[0],C=y[1]+c[1];if(x+=g[0],C+=g[1],"rect"==n)i.beginPath(),i.rect(x-s/2,C-_/2,s,_),e._renderPath(x,C,Math.max(s/2,_/2));else if("image"==n){var S=G.Browser.getImageSrc(t.image),w=G.DomUtil.getImgElement(S,function(){r._requestRedraw()});w._loaded&&(i.save(),i.translate(o(x),o(C)),i.rotate(d/G.MathUtil.DEGREE_PER_RADIAN),i.drawImage(w,0,0,s,_),i.restore())}else if("text"==n){i.save(),i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity,i.font=t.textStyle+" "+s+"px "+t.textFont,i.textAlign=t.textAlign,i.textBaseline="middle";var D=t.text;if(!e._textMeasureWidth||e._textMeasure!=D){var O=i.measureText(D);e._textMeasureWidth=O.width,e._textMeasure=D}i.fillText(D,x,C),i.restore()}else i.beginPath(),i.arc(x,C,s/2,0,2*Math.PI),e._renderPath(x,C,s/2)}},_renderPath:function(e,t,a){var r,i,o=this,n=o._layer,l=n._map,s=n._ctx,_=o.options;if(s.save(),_.fill){if(_.fillImage)r=G.Browser.getimgSrc(_.fillImage),i=G.DomUtil.getImgElement(r,function(){l._requestRedraw()}),i._loaded?(s.fillStyle=s.createPattern(i,"repeat"),s.globalAlpha=_.fillOpacity):s.globalAlpha=0;else if(_.gradual){var c=s.createRadialGradient(e,t,0,e,t,a),d=G.Util.colorRgb(_.fillColor);c.addColorStop(0,_.fillColor),c.addColorStop(1,"rgba("+d[0]+","+d[1]+","+d[2]+","+_.fillOpacity+")"),s.fillStyle=c}else s.fillStyle=_.fillColor,s.globalAlpha=_.fillOpacity;s.fill()}(_.outline||o._mouseOver||o._editing)&&(s.strokeStyle=o._editing?_.lineHighlightColor:_.outline?_.outlineColor:_.fillColor,s.lineWidth=o._mouseOver?_.outlineWidth+_.lineHighlightWiden:_.outlineWidth,s.globalAlpha=_.outlineOpacity,G.Util.setCanvasLineDash(s,_.outlineDashArray),s.stroke()),s.restore()},_onStartEdit:function(){var e=this,t=e._layer,a=t._map,r=e.virtualMouse;for(var i in r.DOWN)a.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(var r in a.DOWN)t.removeListener(a.DOWN[r],e._onVertexDragStart,e);e._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging&&!e.options.allowPan,a._requestRedraw(),e._isVertex?r.addClass(a._layersFrame,"g-edit"):r.addClass(a._layersFrame,"g-clickable");
}},_onMouseOut:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging,a._requestRedraw(),e._isVertex?r.removeClass(a._layersFrame,"g-edit"):r.removeClass(a._layersFrame,"g-clickable")}}}),G.Graphic.Polygon=G.Graphic.Polygon.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a,r=this,i=r.options,o=r._layer,n=o._map,l=o._ctx,s=r.geom,_=n._canvasOffset,c=r.bbox,d=(c[0]+c[2])/2,f=(c[1]+c[3])/2,u=n._calcWrapPointRange([d,f])||[0,0],g=n.options.maxExtent,v=g[2]-g[0];l.save();for(var h=u[0];h<=u[1];h++){l.beginPath();for(var m=0,p=s.length;m<p;m++){t=s[m];for(var y=0,x=t.length;y<x;y++)a=t[y],a=n.toScreen([a[0]+h*v,a[1]]),e=0===y?"moveTo":"lineTo",l[e](a[0]+_[0],a[1]+_[1]);a=t[0],a=n.toScreen([a[0]+h*v,a[1]]),l.lineTo(a[0]+_[0],a[1]+_[1])}if(i.fill){if(i.fillImage){var C=G.Browser.getImageSrc(i.fillImage),S=G.DomUtil.getImgElement(C,function(){n._requestRedraw()},null,"*");S._loaded?(l.fillStyle=l.createPattern(S,"repeat"),l.globalAlpha=i.fillOpacity):l.globalAlpha=0}else l.fillStyle=i.fillColor,l.globalAlpha=i.fillOpacity;l.fill()}(i.outline||r._mouseOver||r._editing)&&(l.strokeStyle=r._editing?i.lineHighlightColor:i.outline?i.outlineColor:i.fillColor,l.lineCap=i.outlineCap,l.lineJoin=i.outlineJoin,l.lineWidth=(i.outline?i.outlineWidth:0)+(r._mouseOver?i.lineHighlightWiden:0),l.globalAlpha=i.outlineOpacity,G.Util.setCanvasLineDash(l,i.outlineDashArray),l.stroke())}l.restore()},_drawMask:function(){var e,t,a,r=this,i=r._map,o=i._maskCtx,n=r.geom,l=i._canvasOffset,s=r.bbox,_=(s[0]+s[2])/2,c=(s[1]+s[3])/2,d=i._calcWrapPointRange([_,c])||[0,0],f=i.options.maxExtent,u=f[2]-f[0];o.beginPath();for(var g=d[0];g<=d[1];g++)for(var v=0,h=n.length;v<h;v++){t=n[v];for(var m=0,p=t.length;m<p;m++)a=t[m],a=i.toScreen([a[0]+g*u,a[1]]),e=0===m?"moveTo":"lineTo",o[e](a[0]+l[0],a[1]+l[1]);a=t[0],a=i.toScreen([a[0]+g*u,a[1]]),o.lineTo(a[0]+l[0],a[1]+l[1])}o.fill()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Polyline=G.Graphic.Polyline.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a=this,r=a.options,i=a._layer,o=i._map,n=i._ctx,l=a.geom,s=o._canvasOffset,_=a.bbox,c=(_[0]+_[2])/2,d=(_[1]+_[3])/2,f=o._calcWrapPointRange([c,d])||[0,0],u=o.options.maxExtent,g=u[2]-u[0];n.save();for(var v=f[0];v<=f[1];v++){n.beginPath();for(var h=0;h<l.length;h++)t=l[h],t=o.toScreen([t[0]+v*g,t[1]]),e=0===h?"moveTo":"lineTo",n[e](t[0]+s[0],t[1]+s[1]);n.strokeStyle=a._editing?r.lineHighlightColor:r.lineColor,n.lineCap=r.lineCap,n.lineJoin=r.lineJoin,n.lineWidth=a._mouseOver?r.lineWidth+r.lineHighlightWiden:r.lineWidth,n.globalAlpha=r.lineOpacity,G.Util.setCanvasLineDash(n,r.lineDashArray),n.stroke()}n.restore()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Map=G.Map.extend({print:function(e,t){var a=this,r=G.DomUtil,i=G.Browser.getCanvasRatio(),o=a.getSize(),n=o[0],l=o[1],s=e||n,_=t||l,c=s/n,d=_/l,f=Math.max(c,d),u=a._onScreenCtx.canvas,g=u.width/i[0],v=u.height/i[1],h=r.create("canvas");return h.width=s,h.height=_,h.getContext("2d").drawImage(u,(s-g*f)/2,(_-v*f)/2,g*f,v*f),h.toDataURL()},_initAddition:function(){var e=this,t=G.DomUtil,a=e._useOffScreen=!window.G_OFF_CANVAS_OFFSCREEN;e._onScreenCtx=t.create("canvas","g-layer",e._layersFrame).getContext("2d"),a&&(e._offScreenCtx=t.create("canvas").getContext("2d")),e._snapshotCtx=t.create("canvas").getContext("2d"),e._maskCtx=t.create("canvas").getContext("2d"),e._mode="canvas"},_redrawSnapshot:function(e,t,a){var r,i,o,n,l,s,_,c=this,d=G.Browser.getCanvasRatio(),f=c._onScreenCtx.canvas,u=f.width/(d[0]||1),g=f.height/(d[1]||1),v=G.Browser.getPxRatio(),h=v[0],m=v[1],p=c._center,y=c._rotate,x=c._res,C=y-t,S=x/a,w=c._onScreenCtx;r=-u/2,i=-g/2,t&&(o=G.MathUtil.rotateVector([r,i],-t),r=o[0],i=o[1]),n=r*a*h+e[0],l=-i*a*m+e[1],r=(n-p[0])/x/h,i=-(l-p[1])/x/m,y&&(o=G.MathUtil.rotateVector([r,i],y),r=o[0],i=o[1]),s=u/2+r,_=g/2+i,c._clearCanvas(w),w.save(),w.translate(s,_),w.rotate(C/G.MathUtil.DEGREE_PER_RADIAN),w.drawImage(c._snapshotCtx.canvas,0,0,u/S,g/S),w.restore()},_redraw:function(){var e=this,t=e._useOffScreen,a=e._onScreenCtx.canvas,r=e._zoomAnim,i=e._rotateAnim,o=e._handlers.Pinch;if(!e.options.canvasAnimRedraw&&r&&r._playing)return void e._redrawSnapshot(r._startCenter,e._rotate,r._startRes);if(!e.options.canvasAnimRedraw&&i&&i._playing)return void e._redrawSnapshot(e._center,i._startRotate,e._res);if(!e.options.canvasAnimRedraw&&o&&o._pinching)return void e._redrawSnapshot(o._startCenter,o._startRotate,o._startRes);t?e._clearCanvas(e._offScreenCtx):e._clearCanvas(e._onScreenCtx);var n,l,s;for(n in e._layerOrder)l=e._layerOrder[n],s=e._layers[l],s&&s.isVisible()&&s._draw();if(e._drawMask(),t){ratio=G.Browser.getCanvasRatio(),w=a.width/(ratio[0]||1),h=a.height/(ratio[1]||1);try{e._clearCanvas(e._onScreenCtx),e._onScreenCtx.drawImage(e._offScreenCtx.canvas,0,0,w,h)}catch(_){}}try{e._onScreenCtx.drawImage(e._maskCtx.canvas,0,0)}catch(_){}e.fireEvent("redraw")},_update:function(){var e,t,a,r=this,i=r._useOffScreen,o=r._onScreenCtx.canvas;i?r._clearCanvas(r._offScreenCtx):r._clearCanvas(r._onScreenCtx);var n,l,s;for(n in r._layerOrder)l=r._layerOrder[n],s=r._layers[l],s&&s.isVisible()&&s._update();if(r._drawMask(),i){e=G.Browser.getCanvasRatio(),t=o.width/(e[0]||1),a=o.height/(e[1]||1);try{r._clearCanvas(r._onScreenCtx),r._onScreenCtx.drawImage(r._offScreenCtx.canvas,0,0,t,a)}catch(_){}}try{r._onScreenCtx.drawImage(r._maskCtx.canvas,0,0)}catch(_){}r.fireEvent("update")},_drawMask:function(){var e,t,a=this,r=a._maskCtx,i=a.options,o=a._masks;if(o){var n=o.length;if(i.mask){if(a._clearCanvas(a._maskCtx),0==n)return;for(r.save(),r.globalCompositeOperation="source-over",r.fillStyle=i.maskColor,r.globalAlpha=i.maskOpacity,r.fillRect(0,0,r.canvas.width,r.canvas.height),r.globalCompositeOperation="destination-out",r.globalAlpha=1,e=0;e<n;e++)t=o[e],t._drawMask&&t._drawMask();r.restore()}}},_onResize:function(){var e=this;e._resizeCanvases(),e._updateDrawSize(),e._requestUpdate()},_clearCanvas:function(e){var t=e.canvas,a=Math.ceil,r=a(t.width),i=a(t.height);e.clearRect(0,0,r,i);var o=G.Browser;if(o.webkit533||o.webkit534){var n=t.style,l=n.display;n.display="none",t.offsetHeight,n.display=l}},_resizeCanvas:function(e,t,a,r){if(e&&t&&a){var i=this,o=e.canvas,n=r?r[0]||1:1,l=r?r[1]||1:1,s=i.options.canvasExpandFactor,_=t*s,c=a*s,d=t+2*_,f=a+2*c;G.DomUtil.setPosition(o,-_,-c),1==n&&1==l?(o.width=d,o.height=f,o.style.width="",o.style.height="",e.scale(1,1)):(o.width=d*n,o.height=f*l,o.style.width=d+"px",o.style.height=f+"px",e.scale(n,l))}},_resizeCanvases:function(){var e=this,t=e.getSize(),a=t[0],r=t[1],i=G.Browser.getCanvasRatio(),o=(i?i[0]||1:1,i?i[1]||1:1,e.options.canvasExpandFactor),n=a*o,l=r*o;e._canvasOffset=[n,l],e._resizeCanvas(e._onScreenCtx,a,r,i),e._resizeCanvas(e._snapshotCtx,a,r,i),e._resizeCanvas(e._maskCtx,a,r,[1,1]),e._useOffScreen&&e._resizeCanvas(e._offScreenCtx,a,r,i)},_onZoomStart:function(e){this._snapshotCanvas()},_onRotateStart:function(e){this._snapshotCanvas()},_onPinchStart:function(e){this._snapshotCanvas()},_snapshotCanvas:function(){var e=this;if(!e.options.canvasAnimRedraw){var t=e._onScreenCtx.canvas,a=G.Browser.getCanvasRatio(),r=t.width/(a[0]||1),i=t.height/(a[1]||1);e._clearCanvas(e._snapshotCtx),e._snapshotCtx.drawImage(t,0,0,r,i)}},_calcCanvasOffset:function(){var e=this,t=e.getSize(),a=e.getDrawSize(),r=a[0],i=a[1],o=(t[0]-r)/2,n=(t[1]-i)/2;return[o,n]},_beforeMergeFramePos:function(){var e=this,t=e._mapFrame,a=G.DomUtil,r=a.getPosition(t),i=r[0],o=r[1],n=e._spark;if(n){var l=a.getPosition(n)||[0,0];a.markPosTransform(n,l[0]+i,l[1]+o),a.updateTransform(n)}try{e._onScreenCtx.drawImage(e._onScreenCtx.canvas,i,o)}catch(s){}}});