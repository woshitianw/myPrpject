G.Layer.Fluid=G.Layer.extend({options:{gridPixels:4,gridMaxDivs:200,gridReduceFactor:2,fieldFactor:.8,fieldMaxIntensity:50,particleMaxAge:100,particleCountFactor:.05,lineWidth:1.2,opacity:1,colors:["#fff","#fff","#fff","#fff","#fff"],searchSteps:3,interpolateCount:4,frameDuration:50},init:function(t){var e=this;e.options=G.Util.merge({},e.options,t),e._idSeq=0,e._dataPoints={},e._tree=new G.RTree,e._nullVector=[NaN,NaN,null],e._dirty=!0,e._builtExtent=[]},start:function(){var t=this;return t._buildGrid(),t._startAnim(),t},stop:function(){var t=this;return clearTimeout(t._timer),t._playing=!1,t},isPlaying:function(){return this._playing},_startAnim:function(){var t=this,e=t._map,i=t.options;t._playing=!0,function r(){try{clearTimeout(t._timer),t._timer=setTimeout(function(){G.Util.requestAnimFrame(r),t._evolve(),e._requestRedraw()},i.frameDuration)}catch(a){console.error(a)}}()},_onReize:function(){var t=this,e=t._map,i=e._useOffScreen?e._offScreenCtx:e._onScreenCtx,r=i.canvas,a=t._ctx,n=a.canvas,o=G.Browser.getCanvasRatio(),_=o?o[0]||1:1,s=o?o[1]||1:1;a.scale(_,s),n.width=r.width,n.height=r.height,t._dirty=!0},_onViewChanged:function(t){var e=this,i=e._map,r=i.getExtent(),a=e._builtExtent;G.ExtentUtil.equals(r,a,2*i._res)||setTimeout(function(){e._dirty=!0},50)},_initContainer:function(){var t=this,e=t._map,i=G.DomUtil;t._ctx||(t._ctx=i.create("canvas").getContext("2d")),e.addListener("resize",t._onReize,t),e.addListener("viewChanged",t._onViewChanged,t),t._onReize()},_onAdded:function(){var t=this,e=t._map;t._initContainer(),e._requestUpdate()},_onRemoved:function(){var t=this,e=t._map;e.removeListener("resize",t._onReize,t),e.removeListener("viewChanged",t._onViewChanged,t)},addDataPoint:function(t,e,i,r,a){var n=this,o=n._map,i=i||0,r=r||0,_=[t,e,t,e],s={x:t,y:e,u:i,v:r};return s.bbox=_,s._id=n._idSeq++,s._addAt=+new Date,n._dataPoints[s._id]=s,n._tree.insert(_,s),n._dirty=!0,a&&o&&o._requestRedraw(),s._id},removeDataPoint:function(t,e){var i=this,r=i._map,a=i._dataPoints[t];return a?(delete i._dataPoints[t],i._tree.remove(a.bbox,a),i._dirty=!0,e&&r&&r._requestRedraw(),i):i},clear:function(t){var e=this,i=e._map;return e._dataPoints={},e._tree.clear(),e._particles=null,e._erase(),e._dirty=!0,!t&&i&&i._requestRedraw(),e},calcField:function(t,e){var i=this,r=i._map,a=(i.options,r.options.maxExtent),n=i._tree.all(),o=n&&n.length,_=Math.sqrt(o)||1,s=Math.max(a[2]-a[0],a[3]-a[1])/_,t=r._calcRealCoords([t,e])[0];if(o>0){var l,c,d=1;do c=[t-d*s,e-d*s,t+d*s,e+d*s],l=i._tree.search(c),d*=2;while(!l||0==l.length);return i._interpolate(t,e,c)}return i._nullVector},hide:function(){var t=this,e=t._map;return t._hidden?t:(t._hidden=!0,t._erase(),e&&e._requestRedraw(),t)},_update:function(){var t=this;t._dirty=!0,t._draw()},_erase:function(){var t=this,e=t._ctx,i=e.canvas,r=i.width,a=i.height;e.clearRect(0,0,r,a)},_draw:function(){var t=this,e=t._map,i=t.options,r=t._ctx;if(t._dirty&&(t._erase(),t._playing&&setTimeout(function(){t._buildGrid(),t._particles=null,t._startAnim()},i.frameDuration)),t._playing){var a=t._particles;if(!a){a=t._particles=[];for(var n=t._gridColCount*t._gridRowCount*i.particleCountFactor,o=0;o<n;o++)a.push(t._createParticle())}if(t._evolve(),!t._batches)return;var _=r.canvas,s=_.width,l=_.height,c=e._canvasOffset;r.globalCompositeOperation="destination-in",r.globalAlpha=.75,r.fillRect(0,0,s,l),r.globalCompositeOperation="source-over",r.globalAlpha=i.opacity,r.lineWidth=i.lineWidth;var d,o,u,h,f,p,v,g,m,x,y,C=e.options.maxExtent,M=t._gridExtent,w=t._gridSize;for(o=0,u=t._batches.length;o<u;o++){for(d=t._batches[o],r.beginPath(),r.strokeStyle=i.colors[o],h=0,f=d.length;h<f;h++)p=d[h],g=M[0]+w*p.x,m=M[1]+w*p.y,x=M[0]+w*p.xt,y=M[1]+w*p.yt,C&&(g<C[0]||g>C[2])||(v=e.toScreen([g,m]),r.moveTo(v[0]+c[0],v[1]+c[1]),v=e.toScreen([x,y]),r.lineTo(v[0]+c[0],v[1]+c[1]),p.x=p.xt,p.y=p.yt);r.stroke()}}if(!t._hidden){var R=e._useOffScreen?e._offScreenCtx:e._onScreenCtx,b=R.canvas;R.drawImage(r.canvas,0,0,b.width,b.height)}},_createParticle:function(t){var e=this;return{x:Math.round(Math.random()*e._gridColCount),y:Math.round(Math.random()*e._gridRowCount),age:void 0===t?Math.floor(Math.random()*e.options.particleMaxAge):t}},_field:function(t,e){var i=this,r=Math.round,a=i._grid,n=a[r(e)],o=n&&n[r(t)]||i._nullVector;return o},_evolve:function(){var t=this,e=(t._map,t.options),i=t._particles;if(i){for(var r,a,n,o,_=e.colors.map(function(){return[]}),s=e.fieldFactor/e.fieldMaxIntensity,l=0,c=i.length;l<c;l++)r=i[l],r.age>e.particleMaxAge&&(r=i[l]=t._createParticle(0)),a=r.x,n=r.y,o=t._field(a,n),o[2]?(r.xt=a+o[0]*s,r.yt=n+o[1]*s,_[t._colorIndex(o[2])].push(r)):r=i[l]=t._createParticle(0),r.age++;t._batches=_}},_buildGrid:function(){var t=this,e=t._map,i=t.options;if(e&&t._dirty){var r=t._gridExtent=e.getExtent(),a=e.options.maxExtent||r,n=e.getSize(),o=Math.max(n[0],n[1]),_=Math.min(o/i.gridPixels,i.gridMaxDivs);G.Browser.mobile&&(_/=i.gridReduceFactor);var s,l,c=t._gridSize=Math.max(r[2]-r[0],r[3]-r[1])/_,d=t._tree.search(r),u=d&&d.length,h=Math.sqrt(u)||1,f=Math.max(r[2]-r[0],r[3]-r[1])/h;t._gridColCount=Math.ceil((r[2]-r[0])/c),t._gridRowCount=Math.ceil((r[3]-r[1])/c);for(var p,v,g=t._grid=[],m=0,x=t._gridRowCount+1;m<x;m++)if(v=r[1]+m*c,v>=a[1]&&v<=a[3]){for(var y=[],C=0,M=t._gridColCount+1;C<M;C++)for(p=r[0]+C*c,y[C]=t._interpolate(p,v,[p-f,v-f,p+f,v+f]),l=1;null===y[C][2]&&l<=i.searchSteps;)l*=2,s=l*f,y[C]=t._interpolate(p,v,[p-s,v-s,p+s,v+s]);g[m]=y}t._dirty=!1,t._builtExtent=e.getExtent()}},_interpolate:function(t,e,i){var r=this,a=Math.sqrt,n=r._tree.search(i);if(!n)return r._nullVector;for(var o,_,s,l,c,d,u,h=0,f=0,p=0,v=0,g=Math.min(r.options.interpolateCount,n.length);v<g;v++){if(c=n[v],o=c.x-t,_=c.y-e,0==o&&0==_)return d=c.u,u=c.v,[d,u,a(d*d+u*u)];s=o*o+_*_,l=Math.sqrt(1/s),h+=c.u*l,f+=c.v*l,p+=l}return p>0?(d=h/p,u=f/p,[d,u,a(d*d+u*u)]):r._nullVector},_colorIndex:function(t){var e=this,i=e.options,r=i.fieldMaxIntensity;return Math.floor(Math.min(t,r)/r*(i.colors.length-1))}});