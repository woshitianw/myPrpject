G.DrawHandler=G.Class.extend({mixins:[G.Event],init:function(e){var r=this;return r._layer=e,r._enabled=!1,r},on:function(){var e=this;return e._enabled||(e._enabled=!0,delete e._graphic,e.afterOn()),e},off:function(){var e=this;if(e._enabled){e._enabled=!1;var r=e._graphic,a=e._layer;r&&a&&a._drawing&&(r instanceof G.Graphic.Polyline||r instanceof G.Graphic.Polygon)&&a.fireEvent("drawEnd",{graphic:r}),e.afterOff()}return e},afterOn:function(){},afterOff:function(){}}),G.DrawHandler.Arrow=G.DrawHandler.extend({afterOn:function(){var e=this,r=e._layer,a=r._map;G.Event.virtualMouse;a.addListener("virtualclick",e._onClick,e),a.addListener("doubleclick",e._onDoubleClick,e)},afterOff:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.MOVE)a.removeListener(o.MOVE[n],e._onMove,e);a.removeListener("virtualclick",e._onClick,e),a.removeListener("doubleclick",e._onDoubleClick,e)},_onClick:function(e){var r=this,a=r._layer,o=a._map,n=(G.DomUtil,r.virtualMouse);e.cancel();var t,i,l=r._graphic,p=[e.mapX,e.mapY];if(l){if(r._ptIndex++,o.options.wrap){var _=l._wrapOffset;p[0]+=_[0],p[1]+=_[1]}t=l.geom,t[r._ptIndex]=p,l.updateGeom(),o._requestRedraw(),a.fireEvent("draw",{graphic:l})}else{var _=[0,0];o.options.wrap&&(p=o._calcRealCoords(p),_=[p[0]-e.mapX,p[1]-e.mapY]),t=[p,p],l=r._graphic=new G.Graphic.Arrow(t,null,a._drawOptions).addTo(a),l._wrapOffset=_,r._ptIndex=0;for(i in n.MOVE)o.addListener(n.MOVE[i],r._onMove,r);r._realDoubleZoom=o.options.doubleZoom,o.options.doubleZoom=!1,o._requestRedraw(),a.fireEvent("drawStart",{graphic:l})}},_onMove:function(e){var r=this,a=r._layer,o=a._map;G.DomUtil,r.virtualMouse;e.cancel();var n,t=r._graphic,i=[e.mapX,e.mapY];if(t){if(o.options.wrap){var l=t._wrapOffset;i[0]+=l[0],i[1]+=l[1]}n=t.geom,n[r._ptIndex+1]=i,t.updateGeom(),o._requestRedraw()}},_onDoubleClick:function(e){var r=this,a=r._layer,o=a._map,n=(G.DomUtil,r.virtualMouse);e.cancel();var t;for(t in n.MOVE)o.removeListener(n.MOVE[t],r._onMove,r);var i=r._graphic;delete r._graphic,o.options.doubleZoom=r._realDoubleZoom||o.options.doubleZoom,i&&(i.geom&&i.geom.length>2&&(i.geom.splice(i.geom.length-1),i.updateGeom()),o._requestRedraw(),a.fireEvent("drawEnd",{graphic:i}))}}),G.DrawHandler.Circle=G.DrawHandler.extend({afterOn:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.DOWN)a.addListener(o.DOWN[n],e._onDown,e)},afterOff:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.DOWN)a.removeListener(o.DOWN[n],e._onDown,e),a.removeListener(o.MOVE[n],e._onMove),a.removeListener(o.UP[n],e._onUp)},_onDown:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e),n.disableImageDrag(),n.disableTextSelection();var t=r.virtualMouse;o.addListener(t.MOVE[e.type],r._onMove,r),o.addListener(t.UP[e.type],r._onUp,r);var i=[e.mapX,e.mapY],l=[0,0];o.options.wrap&&(i=o._calcRealCoords(i),l=[i[0]-e.mapX,i[1]-e.mapY]);var p=[i[0],i[1],0],_=r._graphic=new G.Graphic.Circle(p,null,a._drawOptions).addTo(a);_._wrapOffset=l,a.fireEvent("drawStart",{graphic:_})},_onMove:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e);var t=r._graphic,i=t.geom,l=[e.mapX,e.mapY];if(o.options.wrap){var p=t._wrapOffset;l[0]+=p[0],l[1]+=p[1]}var _=G.MathUtil.calcHypotenuse(l[0]-i[0],l[1]-i[1]);i[2]=_,t.updateGeom(),o._requestRedraw(),a.fireEvent("draw",{graphic:t})},_onUp:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e);var t=r.virtualMouse;for(var i in t.MOVE)o.removeListener(t.MOVE[i],r._onMove),o.removeListener(t.UP[i],r._onUp);a.fireEvent("drawEnd",{graphic:r._graphic})}}),G.DrawHandler.Freepolygon=G.DrawHandler.extend({afterOn:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.DOWN)a.addListener(o.DOWN[n],e._onDown,e)},afterOff:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.DOWN)a.removeListener(o.DOWN[n],e._onDown,e),a.removeListener(o.MOVE[n],e._onMove),a.removeListener(o.UP[n],e._onUp)},_onDown:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e),n.disableImageDrag(),n.disableTextSelection();var t=r.virtualMouse;o.addListener(t.MOVE[e.type],r._onMove,r),o.addListener(t.UP[e.type],r._onUp,r);var i,l=r._graphic,p=[e.mapX,e.mapY];if(!l){var _=[0,0];o.options.wrap&&(p=o._calcRealCoords(p),_=[p[0]-e.mapX,p[1]-e.mapY]),i=[[p]],l=r._graphic=new G.Graphic.Polygon(i,null,a._drawOptions).addTo(a),l._wrapOffset=_}for(var d in t.MOVE)o.addListener(t.MOVE[d],r._onMove,r);a.fireEvent("drawStart",{graphic:l})},_onMove:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e);var t=r._graphic,i=t.geom[0],l=i.length;if(i[l]=[e.mapX,e.mapY],o.options.wrap){var p=t._wrapOffset;i[l][0]+=p[0],i[l][1]+=p[1]}t.updateGeom(),o._requestRedraw(),a.fireEvent("draw",{graphic:t})},_onUp:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e);var t=r._graphic,i=t.geom[0],l=i.length;if(i[l]=[e.mapX,e.mapY],o.options.wrap){var p=t._wrapOffset;i[l][0]+=p[0],i[l][1]+=p[1]}t.updateGeom(),o._requestRedraw();var _=r.virtualMouse;for(var d in _.MOVE)o.removeListener(_.MOVE[d],r._onMove),o.removeListener(_.UP[d],r._onUp);delete r._graphic,a.fireEvent("drawEnd",{graphic:t})}}),G.DrawHandler.Freepolyline=G.DrawHandler.extend({afterOn:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.DOWN)a.addListener(o.DOWN[n],e._onDown,e)},afterOff:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.DOWN)a.removeListener(o.DOWN[n],e._onDown,e),a.removeListener(o.MOVE[n],e._onMove),a.removeListener(o.UP[n],e._onUp)},_onDown:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e),n.disableImageDrag(),n.disableTextSelection();var t=r.virtualMouse;o.addListener(t.MOVE[e.type],r._onMove,r),o.addListener(t.UP[e.type],r._onUp,r);var i,l=r._graphic,p=[e.mapX,e.mapY];if(!l){var _=[0,0];o.options.wrap&&(p=o._calcRealCoords(p),_=[p[0]-e.mapX,p[1]-e.mapY]),i=[p],l=r._graphic=new G.Graphic.Polyline(i,null,a._drawOptions).addTo(a),l._wrapOffset=_}for(var d in t.MOVE)o.addListener(t.MOVE[d],r._onMove,r);a.fireEvent("drawStart",{graphic:l})},_onMove:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e);var t=r._graphic,i=t.geom,l=i.length;if(i[l]=[e.mapX,e.mapY],o.options.wrap){var p=t._wrapOffset;i[l][0]+=p[0],i[l][1]+=p[1]}t.updateGeom(),o._requestRedraw(),a.fireEvent("draw",{graphic:t})},_onUp:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e);var t=r._graphic,i=t.geom,l=i.length;if(i[l]=[e.mapX,e.mapY],o.options.wrap){var p=t._wrapOffset;i[l][0]+=p[0],i[l][1]+=p[1]}t.updateGeom(),o._requestRedraw();var _=r.virtualMouse;for(var d in _.MOVE)o.removeListener(_.MOVE[d],r._onMove),o.removeListener(_.UP[d],r._onUp);delete r._graphic,a.fireEvent("drawEnd",{graphic:t})}}),G.DrawHandler.NormalRect=G.DrawHandler.extend({afterOn:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.DOWN)a.addListener(o.DOWN[n],e._onDown,e)},afterOff:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.DOWN)a.removeListener(o.DOWN[n],e._onDown,e),a.removeListener(o.MOVE[n],e._onMove),a.removeListener(o.UP[n],e._onUp)},_onDown:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e),n.disableImageDrag(),n.disableTextSelection();var t=r.virtualMouse;o.addListener(t.MOVE[e.type],r._onMove,r),o.addListener(t.UP[e.type],r._onUp,r);var i,l=r._graphic,p=[e.mapX,e.mapY];if(!l){var _=[0,0];o.options.wrap&&(p=o._calcRealCoords(p),_=[p[0]-e.mapX,p[1]-e.mapY]),i=[[p]],l=r._graphic=new G.Graphic.Polygon(i,null,a._drawOptions).addTo(a),l._wrapOffset=_}for(var d in t.MOVE)o.addListener(t.MOVE[d],r._onMove,r);a.fireEvent("drawStart",{graphic:l})},_onMove:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e);var t=r._graphic,i=[e.mapX,e.mapY];if(o.options.wrap){var l=t._wrapOffset;i[0]+=l[0],i[1]+=l[1]}var p=r._genRect(t.geom[0][0],i);t.updateGeom(p),o._requestRedraw(),a.fireEvent("draw",{graphic:t})},_onUp:function(e){var r=this,a=r._layer,o=a._map,n=G.DomUtil;n.stopPropagation(e),n.preventDefault(e);var t=r._graphic;t.updateGeom(),o._requestRedraw();var i=r.virtualMouse;for(var l in i.MOVE)o.removeListener(i.MOVE[l],r._onMove),o.removeListener(i.UP[l],r._onUp);delete r._graphic,a.fireEvent("drawEnd",{graphic:t})},_genRect:function(e,r){var a=(G.MathUtil,r[0]-e[0]),o=r[1]-e[1];return[[e,[e[0]+a,e[1]],r,[e[0],e[1]+o]]]}}),G.DrawHandler.Point=G.DrawHandler.extend({afterOn:function(){var e=this,r=e._layer,a=r._map;a.addListener("click",e._onClick,e)},afterOff:function(){var e=this,r=e._layer,a=r._map;a.removeListener("click",e._onClick,e)},_onClick:function(e){var r=this,a=r._layer,o=a._map;G.DomUtil;e.cancel();var n=[e.mapX,e.mapY];o.options.wrap&&(n=o._calcRealCoords(n));var t=r._graphic=new G.Graphic.Point(n,null,a._drawOptions).addTo(a);a.fireEvent("drawStart",{graphic:t}).fireEvent("draw",{graphic:t}).fireEvent("drawEnd",{graphic:t}),o._requestRedraw()}}),G.DrawHandler.Polygon=G.DrawHandler.extend({afterOn:function(){var e=this,r=e._layer,a=r._map;G.Event.virtualMouse;a.addListener("virtualclick",e._onClick,e),a.addListener("doubleclick",e._onDoubleClick,e)},afterOff:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.MOVE)a.removeListener(o.MOVE[n],e._onMove,e);a.removeListener("virtualclick",e._onClick,e),a.addListener("doubleclick",e._onDoubleClick,e)},_onClick:function(e){var r=this,a=r._layer,o=a._map,n=(G.DomUtil,r.virtualMouse);e.cancel();var t,i,l=r._graphic,p=[e.mapX,e.mapY];if(l){if(r._ptIndex++,o.options.wrap){var _=l._wrapOffset;p[0]+=_[0],p[1]+=_[1]}t=l.geom,t[0][r._ptIndex]=p,l.updateGeom(),o._requestRedraw(),a.fireEvent("draw",{graphic:l})}else{var _=[0,0];o.options.wrap&&(p=o._calcRealCoords(p),_=[p[0]-e.mapX,p[1]-e.mapY]),t=[[p,p]],l=r._graphic=new G.Graphic.Polygon(t,null,a._drawOptions).addTo(a),l._wrapOffset=_,r._ptIndex=0;for(i in n.MOVE)o.addListener(n.MOVE[i],r._onMove,r);r._realDoubleZoom=o.options.doubleZoom,o.options.doubleZoom=!1,o._requestRedraw(),a.fireEvent("drawStart",{graphic:l})}},_onMove:function(e){var r=this,a=r._layer,o=a._map;G.DomUtil,r.virtualMouse;e.cancel();var n,t=r._graphic,i=[e.mapX,e.mapY];if(t){if(o.options.wrap){var l=t._wrapOffset;i[0]+=l[0],i[1]+=l[1]}n=t.geom,n[0][r._ptIndex+1]=i,t.updateGeom(),o._requestRedraw()}},_onDoubleClick:function(e){var r=this,a=r._layer,o=a._map,n=(G.DomUtil,r.virtualMouse);e.cancel();var t;for(t in n.MOVE)o.removeListener(n.MOVE[t],r._onMove,r);var i=r._graphic;delete r._graphic,o.options.doubleZoom=r._realDoubleZoom||o.options.doubleZoom,i&&(i.geom&&i.geom[0]&&i.geom[0].length>3&&(i.geom[0].splice(i.geom[0].length-1),i.updateGeom()),o._requestRedraw(),a.fireEvent("drawEnd",{graphic:i}))}}),G.DrawHandler.Polyline=G.DrawHandler.extend({afterOn:function(){var e=this,r=e._layer,a=r._map;G.Event.virtualMouse;a.addListener("virtualclick",e._onClick,e),a.addListener("doubleclick",e._onDoubleClick,e)},afterOff:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.MOVE)a.removeListener(o.MOVE[n],e._onMove,e);a.removeListener("virtualclick",e._onClick,e),a.removeListener("doubleclick",e._onDoubleClick,e)},_onClick:function(e){var r=this,a=r._layer,o=a._map,n=(G.DomUtil,r.virtualMouse);e.cancel();var t,i,l=r._graphic,p=[e.mapX,e.mapY];if(l){if(r._ptIndex++,o.options.wrap){var _=l._wrapOffset;p[0]+=_[0],p[1]+=_[1]}t=l.geom,t[r._ptIndex]=p,l.updateGeom(),o._requestRedraw(),a.fireEvent("draw",{graphic:l})}else{var _=[0,0];o.options.wrap&&(p=o._calcRealCoords(p),_=[p[0]-e.mapX,p[1]-e.mapY]),t=[p,p],l=r._graphic=new G.Graphic.Polyline(t,null,a._drawOptions).addTo(a),l._wrapOffset=_,r._ptIndex=0;for(i in n.MOVE)o.addListener(n.MOVE[i],r._onMove,r);r._realDoubleZoom=o.options.doubleZoom,o.options.doubleZoom=!1,o._requestRedraw(),a.fireEvent("drawStart",{graphic:l})}},_onMove:function(e){var r=this,a=r._layer,o=a._map;G.DomUtil,r.virtualMouse;e.cancel();var n,t=r._graphic,i=[e.mapX,e.mapY];if(t){if(o.options.wrap){var l=t._wrapOffset;i[0]+=l[0],i[1]+=l[1]}n=t.geom,n[r._ptIndex+1]=i,t.updateGeom(),o._requestRedraw()}},_onDoubleClick:function(e){var r=this,a=r._layer,o=a._map,n=(G.DomUtil,r.virtualMouse);e.cancel();var t;for(t in n.MOVE)o.removeListener(n.MOVE[t],r._onMove,r);var i=r._graphic;delete r._graphic,o.options.doubleZoom=r._realDoubleZoom||o.options.doubleZoom,i&&(i.geom&&i.geom.length>2&&(i.geom.splice(i.geom.length-1),i.updateGeom()),o._requestRedraw(),a.fireEvent("drawEnd",{graphic:i}))}}),G.DrawHandler.Rect=G.DrawHandler.extend({afterOn:function(){var e=this,r=e._layer,a=r._map;G.Event.virtualMouse;a.addListener("virtualclick",e._onClick,e),a.addListener("doubleclick",e._onDoubleClick,e)},afterOff:function(){var e=this,r=e._layer,a=r._map,o=e.virtualMouse;for(var n in o.MOVE)a.removeListener(o.MOVE[n],e._onMove,e);a.removeListener("virtualclick",e._onClick,e),a.addListener("doubleclick",e._onDoubleClick,e)},_onClick:function(e){var r=this,a=r._layer,o=a._map,n=(G.DomUtil,r.virtualMouse);e.cancel();var t,i,l=r._graphic,p=[e.mapX,e.mapY];if(l){if(o.options.wrap){var _=l._wrapOffset;p[0]+=_[0],p[1]+=_[1]}r._p2?t=r._genRect(r._p1,r._p2,p):(r._p2=p,t=[[r._p1,p,p]]),l.updateGeom(t),o._requestRedraw(),a.fireEvent("draw",{graphic:l})}else{var _=[0,0];o.options.wrap&&(p=o._calcRealCoords(p),_=[p[0]-e.mapX,p[1]-e.mapY]),r._p1=p,t=[[p,p,p]],l=r._graphic=new G.Graphic.Polygon(t,null,a._drawOptions).addTo(a),l._wrapOffset=_;for(i in n.MOVE)o.addListener(n.MOVE[i],r._onMove,r);r._realDoubleZoom=o.options.doubleZoom,o.options.doubleZoom=!1,o._requestRedraw(),a.fireEvent("drawStart",{graphic:l})}},_onMove:function(e){var r=this,a=r._layer,o=a._map;G.DomUtil,r.virtualMouse;e.cancel();var n,t=r._graphic,i=[e.mapX,e.mapY],l=r._p1,p=r._p2;if(t&&l){if(o.options.wrap){var _=t._wrapOffset;i[0]+=_[0],i[1]+=_[1]}n=p?r._genRect(l,p,i):[[l,i,i]],t.updateGeom(n),o._requestRedraw()}},_onDoubleClick:function(e){var r=this,a=r._layer,o=a._map,n=(G.DomUtil,r.virtualMouse);e.cancel();var t;for(t in n.MOVE)o.removeListener(n.MOVE[t],r._onMove,r);var i=r._graphic;delete r._graphic,delete r._p1,delete r._p2,o.options.doubleZoom=r._realDoubleZoom||o.options.doubleZoom,i&&a.fireEvent("drawEnd",{graphic:i})},_genRect:function(e,r,a){var o=G.MathUtil,n=o.calcDistance(e,r);if(0==n)return[[e,r,a]];var t=(a[0]-e[0])*(r[0]-e[0])+(a[1]-e[1])*(r[1]-e[1]),i=t/n/n,l=e[0]+i*(r[0]-e[0]),p=e[1]+i*(r[1]-e[1]),_=a[0]-l,d=a[1]-p;return _*d==0?[[e,r,a]]:[[e,r,[r[0]+_,r[1]+d],[e[0]+_,e[1]+d]]]}}),G.Layer.Draw=G.Layer.Graphic.extend({forbidKeys:["DoubleClick","Pinch","Drag","ShiftDrag"],startDraw:function(e,r){var a=this,o=a._map;if(a._handler&&a._handler.off(),a._drawOptions=G.Util.merge(r||{},{clickable:!1}),"circle"==e?a._handler=new G.DrawHandler.Circle(a).on():"point"==e?a._handler=new G.DrawHandler.Point(a).on():"polyline"==e?a._handler=new G.DrawHandler.Polyline(a).on():"freepolyline"==e?a._handler=new G.DrawHandler.Freepolyline(a).on():"polygon"==e?a._handler=new G.DrawHandler.Polygon(a).on():"freepolygon"==e?a._handler=new G.DrawHandler.Freepolygon(a).on():"rect"==e?a._handler=new G.DrawHandler.Rect(a).on():"normalrect"==e?a._handler=new G.DrawHandler.NormalRect(a).on():"arrow"==e&&(a._handler=new G.DrawHandler.Arrow(a).on()),a._drawing)return a;G.DomUtil.addClass(o._layersFrame,"g-edit"),a._drawing=!0;var n,t,i,l=a.forbidKeys;for(n in l)t=l[n],i=o._handlers[t],i&&(i._forbidden=!0,i.off());return a},endDraw:function(){var e,r,a,o,n=this,t=n._map;if(n._drawing){o=n._handler,o&&o.off(),delete o._graphic,n._drawing=!1,r=n.forbidKeys;for(e in r)a=r[e],o=t._handlers[a],o&&(o._forbidden=!1);t._resetHandlers(),G.DomUtil.removeClass(t._layersFrame,"g-edit")}return n}});