G.Layer.Heat=G.Layer.extend({mixins:[G.Layer.Filter],options:{radius:30,radiusUnit:"pixel",maxOpacity:1,minOpacity:0,colors:{.2:"#00f",.4:"#0ff",.6:"#0f0",.8:"#ff0",1:"#f00"},topValue:5,drawResolution:1,drawOnAnim:!1},init:function(e){var t=this;t.options=G.Util.merge({},t.options,e),t._idSeq=0,t._dataPoints={},t._tree=new G.RTree,t._updateColorsImage(),t._dirty=!0,t._builtExtent=[]},_onResize:function(){var e=this,t=e._map,a=Math.max(e.options.drawResolution,1),i=t._useOffScreen?t._offScreenCtx:t._onScreenCtx,n=i.canvas,r=e._ctx,o=e._actx,s=r.canvas,d=o.canvas,_=G.Browser.getCanvasRatio(),c=_?_[0]||1:1,l=_?_[1]||1:1;e._bkScale=Math.max(c,l)*a,s.width=d.width=n.width/e._bkScale,s.height=d.height=n.height/e._bkScale,e._dirty=!0},_initContainer:function(){var e=this,t=e._map,a=G.DomUtil;e._ctx||(e._ctx=a.create("canvas").getContext("2d")),e._actx||(e._actx=a.create("canvas").getContext("2d")),e._cctx||(e._cctx=G.DomUtil.create("canvas").getContext("2d")),t.addListener("resize",e._onResize,e),t.addListener("moveEnd",e._onExtentChanged,e),t.addListener("zoomEnd",e._onExtentChanged,e),e._onResize()},_onAdded:function(){var e=this,t=e._map;e._initContainer(),t._requestUpdate()},_onRemoved:function(){var e=this,t=e._map;t.removeListener("resize",e._onResize,e),t.removeListener("moveEnd",e._onExtentChanged,e),t.removeListener("zoomEnd",e._onExtentChanged,e)},_onExtentChanged:function(e){var t=this,a=t._map,i=a.getExtent(),n=t._builtExtent;G.ExtentUtil.equals(i,n,2*a._res)||setTimeout(function(){t._dirty=!0},50)},updateColors:function(){this._updateColorsImage()},addDataPoint:function(e,t,a,i,n){var r=this,o=r._map,s=[e,t,e,t],a=a||1,d=G.Util.isObject(i)?i:{},_={x:e,y:t,val:a,attrs:d};return _.bbox=s,_._id=r._idSeq++,_._addAt=+new Date,r._dataPoints[_._id]=_,r._tree.insert(s,_),r._dirty=!0,n&&o&&o._requestRedraw(),_._id},removeDataPoint:function(e,t){var a=this,i=a._map,n=a._dataPoints[e];return n?(delete a._dataPoints[e],a._tree.remove(n.bbox,n),a._dirty=!0,t&&i&&i._requestRedraw(),a):a},clear:function(e){var t=this,a=t._map;return t._dataPoints={},t._tree.clear(),t._dirty=!0,!e&&a&&a._requestRedraw(),t},_update:function(){var e=this;e._dirty=!0,e._draw()},_draw:function(){var e=this,t=e._map,a=e.options,i=e._ctx,n=i.canvas,r=n.width,o=n.height;if(e._dirty){var s=a.radius;"pixel"==a.radiusUnit&&(s*=t._res);var d=t.getCenter(),_=t._res,c=t.getDrawSize(),l=c[0],u=c[1],h=d[0]-l*_/2-s,f=d[0]+l*_/2+s,m=d[1]-u*_/2-s,p=d[1]+u*_/2+s,v=[h,m,f,p],g=t.options.maxExtent,y=G.ExtentUtil.intersect(v,g);if(!a.drawOnAnim&&(t.isZooming()||t.isPinching()||t.isRotating()||t.isPanning()))return;var x=e._tree.search(y);if(!x)return;var w,C,R=e._actx,L=R.canvas,S=L.width,T=L.height;R.clearRect(0,0,S,T);for(C in x){w=x[C];var I=w._passFilters;I||(I=w._passFilters=e._calcFilter(w.attrs)?1:-1),I&&e._drawA(w.x,w.y,w.val)}var U,O,D=R.getImageData(0,0,S,T),A=D.data,b=A.length,z=Math.min(parseInt(255*a.maxOpacity),255),E=Math.min(z,Math.min(parseInt(255*a.minOpacity),255)),q=e._colorsImage;for(C=0;C<b-3;C+=4)U=A[C+3],U?(O=4*U,A[C]=q[O],A[C+1]=q[O+1],A[C+2]=q[O+2],A[C+3]=E+(z-E)*U/255):E>0&&(A[C]=q[0],A[C+1]=q[1],A[C+2]=q[2],A[C+3]=E);D.data=A,i.clearRect(0,0,r,o),i.putImageData(D,0,0,0,0,r,o),e._dirty=!1,e._builtExtent=t.getExtent()}if(!e._hidden){var M=t._useOffScreen?t._offScreenCtx:t._onScreenCtx,P=M.canvas;M.drawImage(i.canvas,0,0,P.width,P.height)}},_updateColorsImage:function(){var e=this,t=G.DomUtil.create("canvas").getContext("2d"),a=t.canvas;a.width=1,a.height=256;var i=e.options.colors,n=t.createLinearGradient(0,0,1,256);for(var r in i)n.addColorStop(r,i[r]);t.fillStyle=n,t.fillRect(0,0,1,256),e._colorsImage=t.getImageData(0,0,1,256).data},_updateCircle:function(e,t){var a=this,i=a._cctx,n=i.canvas,r=e+2*t,o=2*r;return n.width=n.height=2*r,i.shadowColor="#000",i.shadowOffsetX=i.shadowOffsetY=o,i.shadowBlur=t,i.beginPath(),i.arc(r-o,r-o,e,0,2*Math.PI,!0),i.closePath(),i.fill(),a._circleRadius=e,a._circleR=r,a},_drawA:function(e,t,a){var i=this,n=i._map,r=i.options;if(a){var o=r.topValue,s=r.radius/i._bkScale;"map"==r.radiusUnit&&(s/=n._res),i._circleRadius&&i._circleRadius==s||i._updateCircle(s,s);var d=i._actx,_=n._canvasOffset,c=n.toScreen([e,t]),l=c[0]+_[0],u=c[1]+_[1],h=Math.min(1,a/o);d.globalAlpha=h,d.drawImage(i._cctx.canvas,l/i._bkScale-i._circleR,u/i._bkScale-i._circleR)}}}),G.Layer.TiledGridHeat=G.Layer.TiledService.extend({mixins:[G.Layer.LOD],options:{cluster:[],responseType:"json",gridCols:64,gridRows:64,maxOpacity:1,minOpacity:0,colors:{.2:"#00f",.4:"#0ff",.6:"#0f0",.8:"#ff0",1:"#f00"},topValue:1,drawOnAnim:!1},init:function(e,t,a){var i=this;i.url=e,i._dataFunc=t,i.options=G.Util.merge({},i.options,a),i._tiles={},i._dirtyTiles={},i._dirty=!0;var n=function(e,a,n){var r,o=i._getTileName(e,a,n),s=i._getTileUrl(e,a,n),d=[e,a,n];G.Util.ajax(s,{responseType:i.options.responseType,success:function(e,a){i.onSuccess(d,a),i._tiles[o]={info:d,data:t(d,a)},r=i._map,r&&r._requestRedraw()},error:function(e){i.onError(d)},complete:function(e){i.onComplete(d)}})};G.Layer.TiledService.prototype.init.call(i,n,i.options),i._updateColorsImage()},setUrl:function(e){var t,a=this,i=a._map;for(t in a._loadingKeys)a._stopLoadingByKey(t);return a.url=e,a._dirtyTiles=a._tiles,a._tiles={},a._loadedKeys={},a._dirty=!0,i&&i._requestUpdate(),a},clear:function(){var e,t=this,a=t._map;for(e in t._loadingKeys)t._stopLoadingByKey(e);return t._dirtyTiles={},t._tiles={},t._loadedKeys={},t._dirty=!0,t._onClear(),a&&a._requestUpdate(),t},_onResize:function(){var e=this,t=e._map,a=t._useOffScreen?t._offScreenCtx:t._onScreenCtx,i=a.canvas,n=e._ctx,r=n.canvas;r.width=i.width,r.height=i.height,e._dirty=!0},_onViewChanged:function(e){var t=this,a=t._map;setTimeout(function(){t._dirty=!0,a&&a._requestRedraw()},50)},_initContainer:function(){var e=this,t=e._map,a=G.DomUtil;e._ctx||(e._ctx=a.create("canvas").getContext("2d")),t.addListener("resize",e._onResize,e),e._onResize()},_onAdded:function(){var e=this,t=e._map;e._initContainer(),t._requestUpdate(),e.addListener("loadTileSuccess",e._onLoadTileSuccess,e),e.addListener("unusedTile",e._onUnusedTile,e),e.addListener("allLoaded",e._onAllLoaded,e),t.addListener("viewChanged",e._onViewChanged,e)},_onRemoved:function(){var e=this,t=e._map;e.removeListener("loadTileSuccess",e._onLoadTileSuccess,e),e.removeListener("unusedTile",e._onUnusedTile,e),e.removeListener("allLoaded",e._onAllLoaded,e),t.removeListener("resize",e._onResize,e),t.removeListener("viewChanged",e._onViewChanged,e)},updateColors:function(){this._updateColorsImage()},_onLoadTileSuccess:function(e){var t=this,a=t._map;t._dirty=!0,a&&a._requestRedraw()},_onUnusedTile:function(e){var t=this,a=e.tileInfo,i=t._getTileName(a[0],a[1],a[2]);delete t._tiles[i]},_onAllLoaded:function(e){var t=this,a=t._map;t._dirtyTiles={},a&&a._requestRedraw()},_onUpdated:function(){var e=this;e._dirty=!0,e._draw()},_draw:function(){var e=this,t=e._map,a=e.options,i=e._ctx,n=i.canvas,r=n.width,o=n.height,s=!a.drawOnAnim&&(t.isZooming()||t.isPinching()||t.isRotating()||t.isPanning());if(!s&&e._dirty){var d=Math.min(parseInt(255*a.maxOpacity),255),_=Math.min(d,Math.min(parseInt(255*a.minOpacity),255));i.clearRect(0,0,r,o);for(key in e._dirtyTiles)e._tiles[key]?delete e._dirtyTiles[key]:(tile=e._dirtyTiles[key],e._drawTile(tile,_,d));for(key in e._tiles)tile=e._tiles[key],e._drawTile(tile,_,d);e._dirty=!1}if(!e._hidden){var c=t._useOffScreen?t._offScreenCtx:t._onScreenCtx,l=c.canvas;c.drawImage(i.canvas,0,0,l.width,l.height)}},_updateColorsImage:function(){var e=this,t=G.DomUtil.create("canvas").getContext("2d"),a=t.canvas;a.width=1,a.height=256;var i=e.options.colors,n=t.createLinearGradient(0,0,1,256);for(var r in i)n.addColorStop(r,i[r]);t.fillStyle=n,t.fillRect(0,0,1,256),e._colorsImage=t.getImageData(0,0,1,256).data,e._dirty=!0},_drawTile:function(e,t,a){var i=this,n=i._map,r=i.options,o=e._ctx;if(!o){o=e._tctx=G.DomUtil.create("canvas").getContext("2d");var s=o.canvas,d=s.width=r.gridCols,_=s.height=r.gridRows,c=r.topValue,l=i._colorsImage,u=o.getImageData(0,0,d,_),h=u.data,f=e.data;for(var m in f){var p=f[m],v=4*((r.gridRows-p[1]-1)*r.gridCols+p[0]),g=Math.min(parseInt(p[2]/c*255),255),y=4*g;h[v]=l[y],h[v+1]=l[y+1],h[v+2]=l[y+2],h[v+3]=t+(a-t)*g/255}u.data=h,o.putImageData(u,0,0,0,0,d,_)}var x=Math.round,w=G.Browser.getPxRatio(),C=w[0],R=w[1],L=n._res,S=n._rotate,T=e.info,I=parseInt(T[0]),U=parseInt(T[1]),O=parseInt(T[2]),D=r.tileSize,A=r.zoomReses[O],b=D*A,z=Math.ceil(b/L),E=r.originX+I*b,q=r.originY-U*b,M=n.toScreen([E,q]),P=M[0],k=M[1],K=n._canvasOffset;P+=K[0],k+=K[1],P=x(P),k=x(k);var V=i._ctx;S&&(V.save(),V.translate(P,k),V.rotate(S/G.MathUtil.DEGREE_PER_RADIAN),V.translate(-P,-k));try{V.drawImage(o.canvas,P,k,x(z/C),x(z/R))}catch(B){}S&&V.restore()}}),G.Layer.TiledHeat=G.Layer.TiledService.extend({mixins:[G.Layer.LOD,G.Layer.Filter],options:{cluster:[],responseType:"json",radius:30,radiusUnit:"pixel",maxOpacity:1,minOpacity:0,colors:{.2:"#00f",.4:"#0ff",.6:"#0f0",.8:"#ff0",1:"#f00"},topValue:5,drawResolution:1,drawOnAnim:!1},init:function(e,t,a){var i=this;i.url=e,i._dataFunc=t,i.options=G.Util.merge({},i.options,a),i._tiles={},i._dirtyTiles={},i._dirty=!0;var n=function(e,a,n){var r,o=i._getTileName(e,a,n),s=i._getTileUrl(e,a,n),d=[e,a,n];G.Util.ajax(s,{responseType:i.options.responseType,success:function(e,a){i.onSuccess(d,a),i._tiles[o]=t(d,a),r=i._map,r&&r._requestRedraw()},error:function(e){i.onError(d)},complete:function(e){i.onComplete(d)}})};G.Layer.TiledService.prototype.init.call(i,n,i.options),i._updateColorsImage()},setUrl:function(e){var t,a=this,i=a._map;for(t in a._loadingKeys)a._stopLoadingByKey(t);return a.url=e,a._dirtyTiles=a._tiles,a._tiles={},a._loadedKeys={},a._dirty=!0,i&&i._requestUpdate(),a},clear:function(){var e,t=this,a=t._map;for(e in t._loadingKeys)t._stopLoadingByKey(e);return t._dirtyTiles={},t._tiles={},t._loadedKeys={},t._dirty=!0,t._onClear(),a&&a._requestUpdate(),t},_onResize:function(){var e=this,t=e._map,a=Math.max(e.options.drawResolution,1),i=t._useOffScreen?t._offScreenCtx:t._onScreenCtx,n=i.canvas,r=e._ctx,o=e._actx,s=r.canvas,d=o.canvas,_=G.Browser.getCanvasRatio(),c=_?_[0]||1:1,l=_?_[1]||1:1;e._bkScale=Math.max(c,l)*a,s.width=d.width=n.width/e._bkScale,s.height=d.height=n.height/e._bkScale,e._dirty=!0},_onViewChanged:function(e){var t=this,a=t._map;setTimeout(function(){t._dirty=!0,a&&a._requestRedraw()},50)},_initContainer:function(){var e=this,t=e._map,a=G.DomUtil;e._ctx||(e._ctx=a.create("canvas").getContext("2d")),e._actx||(e._actx=a.create("canvas").getContext("2d")),e._cctx||(e._cctx=G.DomUtil.create("canvas").getContext("2d")),t.addListener("resize",e._onResize,e),e._onResize()},_onAdded:function(){var e=this,t=e._map;e._initContainer(),t._requestUpdate(),e.addListener("loadTileSuccess",e._onLoadTileSuccess,e),e.addListener("unusedTile",e._onUnusedTile,e),e.addListener("allLoaded",e._onAllLoaded,e),t.addListener("viewChanged",e._onViewChanged,e)},_onRemoved:function(){var e=this,t=e._map;e.removeListener("loadTileSuccess",e._onLoadTileSuccess,e),e.removeListener("unusedTile",e._onUnusedTile,e),e.removeListener("allLoaded",e._onAllLoaded,e),t.removeListener("resize",e._onResize,e),t.removeListener("viewChanged",e._onViewChanged,e)},updateColors:function(){this._updateColorsImage()},_onLoadTileSuccess:function(e){var t=this,a=t._map;t._dirty=!0,a&&a._requestRedraw()},_onUnusedTile:function(e){var t=this,a=e.tileInfo,i=t._getTileName(a[0],a[1],a[2]);delete t._tiles[i]},_onAllLoaded:function(e){var t=this,a=t._map;t._dirtyTiles={},a&&a._requestRedraw()},_onUpdated:function(){var e=this;e._dirty=!0,e._draw()},_draw:function(){var e=this,t=e._map,a=e.options,i=e._ctx,n=i.canvas,r=n.width,o=n.height,s=a.radius;"pixel"==a.radiusUnit&&(s*=t._res);var d=!a.drawOnAnim&&(t.isZooming()||t.isPinching()||t.isRotating()||t.isPanning());if(!d&&e._dirty){var _,c,l,u,h=e._actx,f=h.canvas,m=f.width,p=f.height;h.clearRect(0,0,m,p);for(c in e._dirtyTiles)if(e._tiles[c])delete e._dirtyTiles[c];else{_=e._dirtyTiles[c];for(u in _)l=_[u],e._filters&&!e._calcFilter(l[3])||e._drawA(l[0],l[1],l[2])}for(c in e._tiles){_=e._tiles[c];for(u in _)l=_[u],e._filters&&!e._calcFilter(l[3])||e._drawA(l[0],l[1],l[2])}var v,g,y=h.getImageData(0,0,m,p),x=y.data,w=x.length,C=Math.min(parseInt(255*a.maxOpacity),255),R=Math.min(C,Math.min(parseInt(255*a.minOpacity),255)),L=e._colorsImage;for(u=0;u<w-3;u+=4)v=x[u+3],v?(g=4*v,x[u]=L[g],x[u+1]=L[g+1],x[u+2]=L[g+2],x[u+3]=R+(C-R)*v/255):R>0&&(x[u]=L[0],x[u+1]=L[1],x[u+2]=L[2],x[u+3]=R);y.data=x,i.clearRect(0,0,r,o),i.putImageData(y,0,0,0,0,r,o),e._dirty=!1}if(!e._hidden){var S=t._useOffScreen?t._offScreenCtx:t._onScreenCtx,T=S.canvas;S.drawImage(i.canvas,0,0,T.width,T.height)}},_updateColorsImage:function(){var e=this,t=G.DomUtil.create("canvas").getContext("2d"),a=t.canvas;a.width=1,a.height=256;var i=e.options.colors,n=t.createLinearGradient(0,0,1,256);for(var r in i)n.addColorStop(r,i[r]);t.fillStyle=n,t.fillRect(0,0,1,256),e._colorsImage=t.getImageData(0,0,1,256).data,e._dirty=!0},_updateCircle:function(e,t){var a=this,i=a._cctx,n=i.canvas,r=e+2*t,o=2*r;return n.width=n.height=2*r,i.shadowColor="#000",i.shadowOffsetX=i.shadowOffsetY=o,i.shadowBlur=t,i.beginPath(),i.arc(r-o,r-o,e,0,2*Math.PI,!0),i.closePath(),i.fill(),a._circleRadius=e,a._circleR=r,a},_drawA:function(e,t,a){var i=this,n=i._map,r=i.options;if(a){var o=r.topValue,s=r.radius/i._bkScale;"map"==r.radiusUnit&&(s/=n._res),i._circleRadius&&i._circleRadius==s||i._updateCircle(s,s);var d=i._actx,_=n._canvasOffset,c=n.toScreen([e,t]),l=c[0]+_[0],u=c[1]+_[1],h=Math.min(1,a/o);d.globalAlpha=h,d.drawImage(i._cctx.canvas,l/i._bkScale-i._circleR,u/i._bkScale-i._circleR)}}});