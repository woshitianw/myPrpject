G.Layer.Graphic=G.Layer.Graphic.extend({_initContainer:function(){var e=this,t=e._map,i=G.DomUtil,r=e._container=i.create("div","g-layer"),a="g-graphic-container g-zoom-animated";e._svg=i.createSVG("svg",a,r),e._defs=i.createSVG("defs","",e._svg),t._layersFrame.appendChild(r),i.setZIndex(r,e._zIndex)},_update:function(){var e=this;e.isVisible()?e._draw():e._erase()},_draw:function(){var e=this,t=e._map,i=G.DomUtil,r=e._svg,a=i.getPosition(t._mapFrame),o=t.getSize(),n=t.getDrawSize(),s=n[0],l=n[1],_=(s-o[0])/2,d=(l-o[1])/2;if(!(t.isZooming()||t.isDragging()||t.isPanning()||t.isRotating())){i.setZIndex(e._container,e._zIndex),i.show(r),r.style[i.Transform]=i.genTranslateStyle(-_,-d),r.setAttribute("width",s),r.setAttribute("height",l),r.setAttribute("viewBox",[-a[0],-a[1],s,l].join(" "));var u,m,c,p=t.getRedrawExtent();for(m in e._graphics)u=e._graphics[m],c=u.bbox,u._layer&&G.ExtentUtil.overlaps(c,p)?u._draw():u._erase()}},_erase:function(){var e=this,t=e._svg;G.DomUtil.hide(t)},_onClear:function(){var e=this,t=e._svg;if(t){for(t.innerHTML="";t.lastChild;)t.removeChild(t.lastChild);e._defs=G.DomUtil.createSVG("defs","",e._svg)}},_onZoomStart:function(e){var t=this,i=t._map,r=i._mapFrame,a=i._rotate,o=t._svg,n=G.DomUtil,s=n.Transition,l=n.Transform;if(o){t._zooming||(t._zooming=!0);var _=i.getSize(),d=i.getDrawSize(),u=d[0],m=d[1],c=(u-_[0])/2,p=(m-_[1])/2,g=[_[0]/2,_[1]/2],f=e.aroundScreen||g,v=g[0]-f[0],h=g[1]-f[1];if(a&&v&&h){var y=G.MathUtil.rotateVector([v,h],-a);f=[g[0]-y[0],g[1]-y[1]]}f=t._aroundScreen=[f[0]-g[0],f[1]-g[1]];var b=G.DomUtil.genScaleStyle(1/e.scale,f[0],f[1],-c,-p);o.style[l]=b;var S=i._zoomAnim&&i._zoomAnim._params.ignoreAnim;S||(o.style[s]=r.style[s])}},_onZoomUpdate:function(e){var t=this,i=t._map,r=i._mapFrame,a=t._svg,o=G.DomUtil,n=o.Transition,s=o.Transform;if(a&&t._zooming){var l=t._aroundScreen,_=i.getSize(),d=i.getDrawSize(),u=(d[0]-_[0])/2,m=(d[1]-_[1])/2,c=G.DomUtil.genScaleStyle(1/e.scale,l[0],l[1],-u,-m);a.style[s]=c;var p=i._zoomAnim&&i._zoomAnim._params.ignoreAnim;p||(a.style[n]=r.style[n])}},_onZoomEnd:function(){var e=this,t=e._map,i=e._svg,r=G.DomUtil;if(i){var a=t.getSize(),o=t.getDrawSize(),n=(o[0]-a[0])/2,s=(o[1]-a[1])/2;i.style.visibility="",i.parentNode.appendChild(i),i.style[r.Transform]=r.genTranslateStyle(-n,-s),i.style[r.Transition]="",e._zooming=!1}}}),G.Layer.Tile=G.Layer.Tile.extend({_initContainer:function(){var e=this,t=e._map,i=G.DomUtil,r=e._container=i.create("div","g-layer"),a="g-tile-container g-zoom-animated";e._bg=i.create("div",a,e._container),e._front=i.create("div",a,e._container),t._layersFrame.appendChild(e._container),i.setZIndex(r,e._zIndex)},_destroyContainer:function(){var e=this;e._container.parentNode.removeChild(e._container),delete e._container},_update:function(){var e=this,t=e._map;if(t._isLoaded()){var i,r,a,o,n,s,l,_,d,u,m,c=e._zoom=e._calcNearestZoom(!0),p=e._calcVisTileInfos(!0),g=(t.getSize(),t.getCenter()),f=e.options,v=f.zoomReses[c],h=f.tileSize,y=t.getDrawSize(),b=y[0],S=y[1],x=g[0]-b*v/2,A=g[0]+b*v/2,D=g[1]-S*v/2,C=g[1]+S*v/2,L=[x,D,A,C],k=t.options.maxExtent;e._redrawExtent=L;var w=G.ExtentUtil.intersect(L,k);for(var O in e._tiles)a=e._tiles[O],o=a._info,i=o[0],r=o[1],n=o[2],m=f.zoomReses[n],n!==c&&(e._stopLoadingTile(a),(!f.keepResample||f.opacity<1)&&e._removeTile(O)),s=f.originX+i*h*m,l=f.originX+(i+1)*h*m,_=f.originY-(r+1)*h*m,d=f.originY-r*h*m,u=G.ExtentUtil.overlaps([s,_,l,d],w),u||e._tileInfoExist(o,p)||e._removeTile(O);e._placeLoadedTiles(e._bg),e._placeLoadedTiles(e._front);var E=e._calcTileIndex(g[0],g[1],c);e._sortTileInfos(p,E[0],E[1]),e._addTiles(p)}},_draw:function(){var e=this,t=e._map,i=G.DomUtil;t._isLoaded()&&(i.show(e._bg),i.show(e._front),i.setZIndex(e._container,e._zIndex),e._placeLoadedTiles(e._bg),e._placeLoadedTiles(e._front))},_erase:function(){var e=this,t=G.DomUtil;t.hide(e._bg),t.hide(e._front)},_onZoomStart:function(e){var t=this,i=t._map,r=i._mapFrame,a=i.getSize(),o=i._rotate,n=t._front,s=t._bg,l=G.DomUtil,_=l.Transition,d=l.Transform;if(!t._zooming){t._zooming=!0,t._prepareBgBuffer();var u=[a[0]/2,a[1]/2],m=e.aroundScreen||u,c=u[0]-m[0],p=u[1]-m[1];if(o&&c&&p){var g=G.MathUtil.rotateVector([c,p],-o);m=[u[0]-g[0],u[1]-g[1]]}t._aroundScreen=m;var f=i._zoomAnim&&i._zoomAnim._params.ignoreAnim,v=G.DomUtil.genScaleStyle(1/e.scale,m[0],m[1]);n.style[d]=v,s.style[d]=v,f||(n.style[_]=r.style[_],s.style[_]=r.style[_])}},_onZoomUpdate:function(e){var t=this,i=t._front,r=t._bg,a=G.DomUtil,o=a.Transform;if(t._zooming){var n=t._aroundScreen,s=a.genScaleStyle(1/e.scale,n[0],n[1]);i.style[o]=s,r.style[o]=s}},_onZoomEnd:function(){var e=this,t=e._front,i=e._bg,r=G.DomUtil,a=r.Transition,o=r.Transform;t.parentNode.appendChild(t),t.style[o]="",t.style[a]="",i.style[o]="",i.style[a]="",e._zooming=!1},_clearBgBuffer:function(){var e=this,t=e._map;t&&!t._zooming&&(e._bg.innerHTML="")},_prepareBgBuffer:function(){var e=this,t=e._front,i=e._bg;e._stopLoadingTiles(i),e._front=i,e._bg=t},_placeLoadedTiles:function(e){for(var t,i,r,a,o,n,s=this,l=s.options,_=l.zoomReses.length,d=s._calcNearestZoom(!0),u=e.getElementsByTagName("img"),m=0,c=u.length;m<c;m++)t=u[m],t&&t.complete&&(i=t._info,r=parseInt(i[0]),a=parseInt(i[1]),o=parseInt(i[2]),n=o==d?_+1:o,s._placeTile(t,r,a,o,n))},_addTiles:function(e){var t=this;if(0!==e.length){t._numLoad=e.length,t._numLoadSuccess=0,t._numLoadError=0;for(var i,r,a,o,n,s,l,_=document.createDocumentFragment(),d=t.options,u=d.zoomReses.length,m=t.options.errorTileUrl||G.Layer.Tile.EMPTY_TILE,c=0,p=e.length;c<p;c++){if(r=e[c],a=r[0],o=r[1],n=r[2],l=d.zoomReses[n],s=t._getTileName(a,o,n),i=t._tiles[s],i?i.src==m?+new Date-i._responseTime>d.tileLiveMs&&t._loadTile(i,a,o,n):t._numLoadSuccess++:(i=t._getIdleTile(),t._tiles[s]=i,t._loadTile(i,a,o,n)),i.parentNode!==t._front&&(_.appendChild(i),i._wraps))for(var g in i._wraps){var f=i._wraps[g];f&&f.parentNode!==t._front&&_.appendChild(f)}t._placeTile(i,a,o,n,u)}t._front.appendChild(_),t._checkAllHandled()}},_onNewWrapTile:function(e,t){var i=this,r=e._wraps[t];r&&r.parentNode!==i._front&&i._front.appendChild(r)}}),G.Layer.Label=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{icons:"",cluster:[],crossOrigin:"*"},init:function(e,t){var i=this;G.Layer.Graphic.prototype.init.call(i,t),i.url=e,i.options=G.Util.merge({},i.options,t),i._lts={},i._gx=i._gy=10},_initContainer:function(){var e=this;G.Layer.Graphic.prototype._initContainer.call(e)},_onAdded:function(){var e=this;e._container||e._initContainer()},_onRemoved:function(){var e=this;e._container&&e._destroyContainer()},_update:function(){var e=this,t=e._map;if(G.Layer.Graphic.prototype._update.call(e),t._isLoaded()){var i=e._zoom=e._calcNearestZoom(!0),r=t.getCenter();e._clearGrids();var a=t._zoomAnim;if(a&&a._playing);else{var o=e._calcVisTileInfos(),n=e._calcTileIndex(r[0],r[1],i);e._sortTileInfos(o,n[0],n[1]),e._setLts(o)}}},_setLts:function(e){var t=this;if(e.length){for(var i,r,a,o,n,s,l=[],_=0,d=e.length;_<d;_++)a=e[_],o=a[0],n=a[1],s=a[2],i=t._getTileName(o,n,s),l.push(i),i in t._lts?(r=t._lts[i],r.loading||r.data||r.ri||t._loadLtI(o,n,s)):t._loadLtI(o,n,s),t._placeLt(i);t._dirtyTileKeys=t._dirtyTileKeys||[];for(i in t._lts)l.indexOf(i)>-1||(t._stopLoadingLt(i),t._dirtyTileKeys.push(i))}},_checkDirtyTiles:function(){var e,t=this,i=t._dirtyTileKeys;if(i&&i.length>0)for(var r=0,a=i.length;r<a;r++)e=i[r],t._removeLt(e);t._dirtyTileKeys=[]},_placeLt:function(e){var t=this,i=t._lts[e];if(i&&i._info&&i.data){var r,a,o,n,s,l,_,d,u,m,c,p,g,f,v,h,y,b,S,x,A=i.data.l;for(r in A){a=A[r],o=Number(a[0]),n=Number(a[1]),s=Number(a[2]),l=Number(a[3]),_=Number(a[4]),d=Number(a[5]),u=a[6],h=[o,n],y="imgs"+r,b=i[y];for(S in b)m=b[S],c=m[0],p=m[1],g=m[2],f=m[3],v=m[4],x=m[5],x||(m[5]=x=new G.Graphic.Point(h,null,{shape:"image",size:[p,g],offset:[f,v],image:c,imageGravity:!!u}),x.addTo(t))}}},_removeLt:function(e){var t=this,i=t._lts[e];if(i&&i._info&&i.data){t._stopLoadingLt(e);var r,a,o,n,s,l=i.data.l;for(r in l){o="imgs"+r,n=i[o];for(s in n)a=n[s],g=a[5],g&&g.remove()}delete t._lts[e]}},_loadLtI:function(e,t,i){var r=this,a=r._getTileName(e,t,i),o=r._lts[a]=r._lts[a]||{};if(o._info=[e,t,i],""!==o.data){o.loading=!0;var n=r._getTileUrl(e,t,i,{d:"i",i:G.Browser.retina?"@2x":""}),s={};r.options.crossOrigin&&(s.crossOrigin=r.options.crossOrigin);var l={responseType:"http"===n.slice(0,4).toLowerCase()?"JSONP":"JSON",header:s,success:function(e,t){o.data=t,r._processLt(a)},error:function(e){404==e.status&&(o.data="")},complete:function(){delete o.ri,o.loading=!1}};r.options.crossOrigin&&(l.responseType="JSON");var _=G.Util.ajax(n,l);o.ri=_}},_processLt:function(e){var t=this,i=t._lts[e],r=i.data;if(r){var a,o,n,s,l,_,d,u,m,c,p,g,f,v,h,y,G,b,S,x,A,D=r.l,C=r.b,L=r.i,k=r.bb,w=t.options.icons||"";for(o in D){if(a=D[o],n=Number(a[0]),s=Number(a[1]),l=a[6],C&&o in C)for(f=C[o],x=0,A=f.length;x<A;x++)v=f[x],_=v[0],d=v[1],u=v[2],m=v[3],c=v[4],p=v[5],0!=p&&k&&(G=k.slice(c,c+p),b="data:image/png;base64,"+G,S="b"+x,i["imgs"+o]=i["imgs"+o]||{},i["imgs"+o][S]=[b,_,d,u,m]);if(L&&o in L)for(h=L[o],x=0,A=h.length;x<A;x++)y=h[x],_=y[0],d=y[1],u=y[2],m=y[3],g=y[4],b=w+g,S="i"+x,i["imgs"+o]=i["imgs"+o]||{},i["imgs"+o][S]=[b,_,d,u,m]}t._checkDirtyTiles(),t._placeLt(e)}},_stopLoadingLt:function(e){var t=this._lts[e],i=G.Util.ajaxCancel;t&&(i(t.ri),t.loading=!1)},_onIconLoad:function(){this._dirtyIcons=!0},_clearGrids:function(){this._g={}},_hitGrids:function(e,t,i,r){for(var a,o=this,n=e;n<=i;n++)for(var s=t;s<=r;s++)if(a=n+","+s,o._g[a])return!0;return!1},_markGrids:function(e,t,i,r){for(var a,o=this,n=e;n<=i;n++)for(var s=t;s<=r;s++)a=n+","+s,o._g[a]=!0}}),G.Layer.FeatureService=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{mode:"all",vacuumCount:1e3},init:function(e,t){var i=this;G.Layer.Graphic.prototype.init.call(i,t),i.options=G.Util.merge({},i.options,t),i._reqFunc=e,i._loadingKeys={}},onSuccess:function(e){var t=this;"tile"==t.options.mode?t.fireEvent("loadTileSuccess",{extent:e}):t.fireEvent("loadAllSuccess")},onError:function(e){var t=this;"tile"==t.options.mode?t.fireEvent("loadTileError",{extent:e}):t.fireEvent("loadAllError")},onComplete:function(e){var t=this;if("tile"==t.options.mode){var i=e.join(",");delete t._loadingKeys[i],t.fireEvent("loadTileComplete",{extent:e})}else t.fireEvent("loadAllComplete")},_update:function(){var e=this,t=e._map;if(G.Layer.Graphic.prototype._update.call(e),t._isLoaded())if("tile"==e.options.mode){var i=e.count();i>e.options.vacuumCount&&e._vacuum();var r=e._calcVisTileInfos();e._addFts(r)}else e._loadAll()},_addFts:function(e){var t=this;if(0!==e.length){var i,r,a,o,n,s,l,_,d,u=t._loadingKeys,m={};for(i=0,r=e.length;i<r;i++)n=e[i],s=n[0],l=n[1],_=n[2],d=t._calcTileExtent(s,l,_),a=d.join(","),m[a]=d;for(a in u)m[a]||(o=u[a],G.Util.ajaxCancel(o),delete u[a]);for(a in m)d=m[a],t._loadFt(d)}},_loadFt:function(e){var t=this,i=e.join(","),r=t._reqFunc;if(!(i in t._loadingKeys)&&r){var a=r.call(t,e);t._loadingKeys[i]=a,t.fireEvent("loadTileStart",{extent:e})}},_loadAll:function(){var e=this,t="all",i=e._reqFunc;if(!(t in e._loadingKeys)&&i){var r=i.call(e);e._loadingKeys[t]=r,e.fireEvent("loadAllStart")}}}),G.Layer.GeoHeyFeature=G.Layer.FeatureService.extend({options:{apiKey:"",where:"1=1",outFields:"",limit:1e3},init:function(e,t){var i=this,r=function(t){var r=e+"/query",a=i.options,o={ak:a.apiKey,where:a.where,outFields:a.outFields,limit:a.limit};t&&(o.geometry=JSON.stringify(t));var n={responseType:"http"===r.slice(0,4).toLowerCase()?"JSONP":"JSON",data:o,success:function(e,r){var o=r.data,n=o.geometryType,s=o.features;if(s){var l,_,d,u,m,c,p,g,f=s.length-1,v=Math.max(0,f-a.limit),h=[];for(l=f;l>=v;l--){_=s[l],d=_.id,u=_.geom,m=_.attrs||{},"Point"==n?h.push(new G.Graphic.Point(u,m)):"Polyline"==n?h.push(new G.Graphic.Polyline(u,m)):"Polygon"==n?h.push(new G.Graphic.Polygon(u,m)):"MultiPoint"==n?h.push(new G.Graphic.MultiPoint(u,m)):"MultiPolyline"==n?h.push(new G.Graphic.MultiPolyline(u,m)):"MultiPolygon"==n&&h.push(new G.Graphic.MultiPolygon(u,m));for(p in h)g=h[p],g&&(c=d+"_"+p,i.get(c)||g.addTo(i,c))}}i.onSuccess(t)},error:function(){i.onError(t)},complete:function(){i.onComplete(t)}};G.Util.ajax(r,n)};G.Layer.FeatureService.prototype.init.call(i,r,t)}}),G.Layer.GeoHeyProgressiveFeature=G.Layer.Graphic.extend({options:{stepFactor:4,stepCount:4,tolerance:8,outFields:"[]"},init:function(e,t){var i=this;G.Layer.Graphic.prototype.init.call(i,t),i.url=e},onSuccess:function(e){this.fireEvent("extentSuccess",{extent:e})},onError:function(e){this.fireEvent("extentError",{extent:e})},onComplete:function(e){var t=this;t.fireEvent("extentComplete",{extent:e})},_update:function(){var e=this,t=e._map,i=e._loadRes=t._res,r=e._loadExtent=t.getExtent(),a=e._loadedStatus;if((!a||i!=a[0]||!G.ExtentUtil.equals(r,a[1]))&&(G.Layer.Graphic.prototype._update.call(e),t._isLoaded())){var o=e._req;o&&G.Util.ajaxCancel(o);var n,s,l=e._graphics;for(s in l)n=l[s],n._dirty=!0;e._loadStep(1)}},_loadStep:function(e){var t=this,i=t.options,r=t._loadRes,a=t._loadExtent,o=i.tolerance*Math.pow(i.stepFactor,i.stepCount-e),n=t.url+"/filter",s={responseType:"JSON",data:{extent:JSON.stringify(a),excludeExtents:JSON.stringify([]),res:r,cellPixel:o,outFields:i.outFields},success:function(i,r){t._processResult(e,r)},complete:function(){t._req=null}};t._req=G.Util.ajax(n,s)},_processResult:function(e,t){var i=this,r=i.options,a=i._loadRes,o=i._loadExtent,n=r.tolerance*Math.pow(r.stepFactor,r.stepCount-e),s=a*n,l=t.geometryType,_=t.features;if(!_)return i.onError(o),void i.onComplete(o);var d,u,m,c,p,g,f,v,h=_.length-1;for(d=h;d>=0;d--)if(u=_[d],m=u.id,c=u.geom,p=u.attrs||{},"Point"==l)v=new G.Graphic.Point(c,p),i._updateGraphic(s,m,0,v);else if("Polyline"==l)v=new G.Graphic.Polyline(c,p),i._updateGraphic(s,m,0,v);else if("Polygon"==l)v=new G.Graphic.Polygon(c,p),i._updateGraphic(s,m,0,v);else if("MultiPoint"==l)for(g in c.multi)f=c.multi[g],v=new G.Graphic.Point(f,p),i._updateGraphic(s,m,g,v);else if("MultiPolyline"==l)for(g in c.multi)f=c.multi[g],v=new G.Graphic.Polyline(f,p),i._updateGraphic(s,m,g,v);else if("MultiPolygon"==l)for(g in c.multi)f=c.multi[g],v=new G.Graphic.Polygon(f,p),i._updateGraphic(s,m,g,v);e<r.stepCount?i._loadStep(e+1):(i._clearDirty(),i._loadedStatus=[a,o],i.onSuccess(o),i.onComplete(o))},_updateGraphic:function(e,t,i,r){var a=this,o=t+(i?"_"+i:""),n=a.get(o);n?(e<n._res&&(n.updateGeom(r.geom,!0),n._res=e),n._dirty=!1):(r._res=e,r.addTo(a,o))},_clearDirty:function(){var e,t,i=this,r=i._graphics;for(t in r)e=r[t],e._dirty&&e.remove()}}),G.Layer.TiledService=G.Layer.extend({mixins:[G.Layer.LOD],init:function(e,t){var i=this;i.options=G.Util.merge({},i.options,t),i._reqFunc=e,i._loadingKeys={},i._loadedKeys={}},onSuccess:function(e,t){var i=this;i._numLoadSuccess++;var r=parseInt(e[0]),a=parseInt(e[1]),o=parseInt(e[2]),n=i._getTileName(r,a,o);i._loadedKeys[n]=e,i.fireEvent("loadTileSuccess",{tileInfo:e,data:t})},onError:function(e){var t=this;t._numLoadError++,t.fireEvent("loadTileError",{tileInfo:e})},onComplete:function(e){var t=this,i=parseInt(e[0]),r=parseInt(e[1]),a=parseInt(e[2]),o=t._getTileName(i,r,a);delete t._loadingKeys[o],t.fireEvent("loadTileComplete",{tileInfo:e}),t._checkAllHandled()},_update:function(){var e=this,t=e._map;if(t._isLoaded()){var i,r,a,o,n,s,l,_=e._calcVisTileInfos(),d={};for(i=0,r=_.length;i<r;i++)o=_[i],n=o[0],s=o[1],l=o[2],a=e._getTileName(n,s,l),d[a]=o;e._addTiles(d);for(a in e._loadedKeys)d[a]||(o=e._loadedKeys[a],delete e._loadedKeys[a],e.fireEvent("unusedTile",{tileInfo:o}));e._onUpdated()}},_addTiles:function(e){var t,i,r,a=this,o=a._loadingKeys;for(t in o)e[t]||(i=o[t],G.Util.ajaxCancel(i),delete o[t]);a._numLoad=Object.keys(e).length,a._numLoadSuccess=0,a._numLoadError=0;for(t in e)r=e[t],a._loadTile(r);a._checkAllHandled()},_loadTile:function(e){var t=this,i=t._reqFunc,r=parseInt(e[0]),a=parseInt(e[1]),o=parseInt(e[2]),n=t._getTileName(r,a,o);if(!(n in t._loadingKeys)&&i){if(n in t._loadedKeys)return void t._numLoadSuccess++;var s=i.call(t,r,a,o);t._loadingKeys[n]=s,t.fireEvent("loadTileStart",{tileInfo:e})}},_stopLoadingByKey:function(e){var t=this._loadingKeys,i=t[e];i&&(G.Util.ajaxCancel(i),delete t[e])},_checkAllHandled:function(){var e=this;e._numLoad==e._numLoadSuccess+e._numLoadError&&e.fireEvent("allLoaded")},_onUpdated:function(){}}),G.Graphic.Arrow=G.Graphic.Arrow.extend({_onAdded:function(){var e=this;e._dom||(e._dom=G.DomUtil.createSVG("g")),e._polygons={};var t=e._layer._map;t&&t._requestRedraw()},_onRemoved:function(){var e=this,t=e._dom;t&&t.parentNode&&t.parentNode.removeChild(t);var i=e._layer._map;i&&i._requestRedraw()},_draw:function(){var e=this,t=G.DomUtil,i=(e.options,e._layer),r=i._map;if(e._updateGeomDraw(r._res),e._geomDraw){var a=i._svg;e._dom&&a&&!e._dom.parentNode&&a.appendChild(e._dom);for(var o=r.getSize(),n=r.getDrawSize(),s=(n[0]-o[0])/2,l=(n[1]-o[1])/2,_=e._geomDraw,d=(_.length,e.bbox),u=(d[0]+d[2])/2,m=(d[1]+d[3])/2,c=r._calcWrapPointRange([u,m])||[0,0],p=r.options.maxExtent,g=p[2]-p[0],f=c[0];f<=c[1];f++){var v=e._polygons[f];v||(v=e._polygons[f]=t.createSVG("path"),v._graphic=e,e._dom.appendChild(v));for(var h,y,b,S,x,A="",D=0,C=_.length;D<C;D++){h=_[D],y="";for(var L=0,k=h.length;L<k;L++)b=r.toScreen([h[L][0]+f*g,h[L][1]],0,0,!0),S=b[0]+s,x=b[1]+l,y+=0===L?" M ":"",y+=1===L?" L ":" ",y+=S+" "+x;y+=" Z",A+=y}v.setAttribute("d",A)}e._updateStyles()}},_updateStyles:function(){var e=this,t=G.DomUtil,i=e.options,r=e._layer,a=r._defs;for(var o in e._polygons){var n=e._polygons[o];if(i.outline||e._mouseOver||e._editing?(n.setAttribute("stroke",e._editing?i.lineHighlightColor:i.outline?i.outlineColor:i.fillColor),n.setAttribute("stroke-dasharray",i.outlineDashArray.join(" ")),n.setAttribute("stroke-linecap",i.outlineCap),n.setAttribute("stroke-linejoin",i.outlineJoin),n.setAttribute("stroke-width",(i.outline?i.outlineWidth:0)+(e._mouseOver?i.lineHighlightWiden:0)),n.setAttribute("stroke-opacity",i.outlineOpacity)):n.setAttribute("stroke","none"),i.fill){if(i.fillImage){var s=G.Browser.getImageSrc(i.fillImage),l=i.fillImageSize,_=t.svgImagePattern(a,s,l[0],l[1]);n.setAttribute("fill","url(#"+_+")")}else n.setAttribute("fill",i.fillColor);n.setAttribute("fill-opacity",i.fillOpacity)}else n.setAttribute("fill","none")}},_updateMask:function(){var e=this,t=G.DomUtil,i=(e.options,e._map);if(e._updateGeomDraw(i._res),e._geomDraw){e._masks=e._masks||{};for(var r=i.getSize(),a=i.getDrawSize(),o=(a[0]-r[0])/2,n=(a[1]-r[1])/2,s=e._geomDraw,l=(s.length,e.bbox),_=(l[0]+l[2])/2,d=(l[1]+l[3])/2,u=i._calcWrapPointRange([_,d])||[0,0],m=i.options.maxExtent,c=m[2]-m[0],p=u[0];p<=u[1];p++){var g=e._masks[p];g||(g=e._masks[p]=t.createSVG("path"),g._graphic=e);for(var f,v,h,y,b,S="",x=0,A=s.length;x<A;x++){f=s[x],v="";for(var D=0,C=f.length;D<C;D++)h=i.toScreen([f[D][0]+p*c,f[D][1]],0,0,!0),y=h[0]+o,b=h[1]+n,v+=0===D?" M ":"",v+=1===D?" L ":" ",v+=y+" "+b;v+=" Z",S+=v}g.setAttribute("d",S)}}},_onStartEdit:function(){var e=this,t=e._layer._map,r=e.virtualMouse;for(i in r.DOWN)t.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,i=this,r=i._layer._map,a=i.virtualMouse;for(e in a.DOWN)t=a.DOWN[e],r.removeListener(t,i._onVertexDragStart,i),r.removeListener(a.MOVE[t],i._onVertexDrag,i),r.removeListener(a.UP[t],i._onVertexDragEnd,i);i._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Circle=G.Graphic.Circle.extend({_onAdded:function(){var e=this;e._dom||(e._dom=G.DomUtil.createSVG("g")),e._circles={};var t=e._layer._map;t&&t._requestRedraw()},_onRemoved:function(){var e=this,t=e._dom;t&&t.parentNode&&t.parentNode.removeChild(t);var i=e._layer._map;i&&i._requestRedraw()},_draw:function(){var e=this,t=G.DomUtil,i=(e.options,e._layer),r=i._map;if(e.geom){var a=i._svg;e._dom&&a&&!e._dom.parentNode&&a.appendChild(e._dom);for(var o=r.getSize(),n=r.getDrawSize(),s=(n[0]-o[0])/2,l=(n[1]-o[1])/2,_=r._res,d=e.geom[0],u=e.geom[1],m=e.geom[2],c=r._calcWrapPointRange(e.geom)||[0,0],p=r.options.maxExtent,g=p[2]-p[0],f=c[0];f<=c[1];f++){var v=e._circles[f];v||(v=e._circles[f]=t.createSVG("circle"),v._graphic=e,e._dom.appendChild(v));var h=r.toScreen([d+f*g,u],0,0,!0),y=h[0]+s,b=h[1]+l,S=m/_;v.setAttribute("cx",y),v.setAttribute("cy",b),v.setAttribute("r",S)}e._updateStyles()}},_updateStyles:function(){var e=this,t=G.DomUtil,i=e.options,r=e._layer,a=r._defs;for(var o in e._circles){var n=e._circles[o];if(i.outline||e._mouseOver||e._editing?(n.setAttribute("stroke",e._editing?i.lineHighlightColor:i.outline?i.outlineColor:i.fillColor),n.setAttribute("stroke-dasharray",i.outlineDashArray.join(" ")),n.setAttribute("stroke-linecap",i.outlineCap),n.setAttribute("stroke-linejoin",i.outlineJoin),n.setAttribute("stroke-width",e._mouseOver?i.outlineWidth+i.lineHighlightWiden:i.outlineWidth),n.setAttribute("stroke-opacity",i.outlineOpacity)):e._mouseOver?(n.setAttribute("stroke",i.outlineColor),n.setAttribute("stroke-width",e._mouseOver?i.lineHighlightWiden:0)):n.setAttribute("stroke","none"),i.fill)if(i.fillImage){var s=G.Browser.getImageSrc(i.fillImage),l=i.fillImageSize,_=t.svgImagePattern(a,s,l[0],l[1]);n.setAttribute("fill","url(#"+_+")"),n.setAttribute("fill-opacity",i.fillOpacity)}else if(i.gradual){var d=t.svgGradient(a,i.fillColor,i.fillOpacity);n.setAttribute("fill","url(#"+d+")")}else n.setAttribute("fill",i.fillColor),n.setAttribute("fill-opacity",i.fillOpacity);else n.setAttribute("fill","none")}},_updateMask:function(){var e=this,t=G.DomUtil,i=(e.options,e._map);if(e.geom){e._masks=e._masks||{};for(var r=i.getSize(),a=i.getDrawSize(),o=(a[0]-r[0])/2,n=(a[1]-r[1])/2,s=i._res,l=e.geom,_=(l.length,e.bbox,l[0]),d=l[1],u=l[2],m=i._calcWrapPointRange([_,d])||[0,0],c=i.options.maxExtent,p=c[2]-c[0],g=m[0];g<=m[1];g++){var f=e._masks[g];f||(f=e._masks[g]=t.createSVG("circle"),f._graphic=e);var v=i.toScreen([_+g*p,d],0,0,!0),h=v[0]+o,y=v[1]+n,b=u/s;f.setAttribute("cx",h),f.setAttribute("cy",y),f.setAttribute("r",b)}}},_onStartEdit:function(){var e=this,t=e._layer._map,r=e.virtualMouse;for(i in r.DOWN)t.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,i=this,r=i._layer._map,a=i.virtualMouse;for(e in a.DOWN)t=a.DOWN[e],r.removeListener(t,i._onVertexDragStart,i),r.removeListener(a.MOVE[t],i._onVertexDrag,i),r.removeListener(a.UP[t],i._onVertexDragEnd,i);i._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Group=G.Graphic.Group.extend({_updateStyles:function(){var e,t,i,r=this,a=r._graphics;if(a&&a.length)for(e=0,t=a.length;e<t;e++)i=a[e],i._updateStyles&&i._updateStyles()},_onMouseOver:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.MultiPoint=G.Graphic.MultiPoint.extend({_onAdded:function(){var e=this;e._dom||(e._dom=G.DomUtil.createSVG("g")),e._pointss={};var t=e._layer._map;t&&t._requestRedraw()},_onRemoved:function(){var e=this,t=e._dom;t&&t.parentNode&&t.parentNode.removeChild(t);var i=e._layer._map;i&&i._requestRedraw()},_draw:function(){var e=this,t=G.DomUtil,i=e.options,r=e._layer,a=r._map,o=e.geom;if(o&&o.m){var n=r._svg;e._dom&&n&&!e._dom.parentNode&&n.appendChild(e._dom);var s=a.getSize(),l=a.getDrawSize(),_=(l[0]-s[0])/2,d=(l[1]-s[1])/2,u=a._rotate,m=i.shape,c=i.size,p=c[0],g=c[1],f=i.offset,v=i.imageRotate;"image"==m&&v&&(u-=v),"image"!=m||i.imageGravity||(u-=a._rotate);for(var h,y,b,S=o.m,x=e.bbox,A=(x[0]+x[2])/2,D=(x[1]+x[3])/2,C=a._calcWrapPointRange([A,D])||[0,0],L=a.options.maxExtent,k=L[2]-L[0],w=C[0];w<=C[1];w++)for(var O=e._pointss[w]=e._pointss[w]||[],E=0;E<S.length;E++){h=S[E],y=h[0],b=h[1];var U=O[E];U||(U="rect"==m?e._pointss[w][E]=t.createSVG("rect"):"image"==m?e._pointss[w][E]=t.createSVG("image"):"text"==m?e._pointss[w][E]=t.createSVG("text"):e._pointss[w][E]=t.createSVG("circle"),U._graphic=e,e._dom.appendChild(U));var N=a.toScreen([y+w*k,b],0,0,!0),V=N[0]+_,T=N[1]+d,z=V+f[0],M=T+f[1],I="rotate("+-u+","+V+","+T+")";if("circle"==m)U.setAttribute("cx",z),U.setAttribute("cy",M),U.setAttribute("r",p/2);else if("rect"==m)U.setAttribute("x",z-p/2),U.setAttribute("y",M-g/2),U.setAttribute("width",p),U.setAttribute("height",g);else if("image"==m){U.setAttribute("x",z),U.setAttribute("y",M),U.setAttribute("width",p),U.setAttribute("height",g);var W=G.Browser.getImageSrc(i.image);U.setAttributeNS(G.DomUtil.XLINK_NS,"href",W)}else if("text"==m){var P=i.text;if(!e._textMeasureWidth||e._textMeasure!=P){var F=t.create("div","",document.body);F.style.position="absolute",F.style.visibility="hidden",F.style.width=F.style.height="auto",F.style.fontFamily=i.textFont,F.style.fontStyle="italic"==i.textStyle?"italic":"normal",F.style.fontWeight="bold"==i.textStyle?"bold":"normal",F.style.fontSize=p+"px",F.innerHTML=P,e._textMeasureWidth=F.clientWidth+4,F.parentNode.removeChild(F),e._textMeasure=P}U.setAttribute("x",z),U.setAttribute("y",M),U.setAttribute("font-size",p+"px"),U.setAttribute("text-anchor","center"==i.textAlign?"middle":"left"==i.textAlign?"start":"end"),U.setAttribute("alignment-baseline","middle"),U.setAttribute("font-family",i.textFont),U.setAttribute("font-style","italic"==i.textStyle?"italic":"normal"),U.setAttribute("font-weight","bold"==i.textStyle?"bold":"normal"),U.innerHTML=U.textContent=i.text}U.setAttribute("transform",I)}e._updateStyles()}},_updateStyles:function(){var e=this,t=G.DomUtil,i=e.options,r=e._layer,a=r._defs;for(var o in e._pointss){var n=e._pointss[o];for(var s in n){var l=n[s];if((i.outline||e._mouseOver||e._editing)&&"text"!=i.shape?(l.setAttribute("stroke",e._editing?i.lineHighlightColor:i.outline?i.outlineColor:i.fillColor),l.setAttribute("stroke-dasharray",i.outlineDashArray.join(" ")),l.setAttribute("stroke-width",e._mouseOver?i.outlineWidth+i.lineHighlightWiden:i.outlineWidth),l.setAttribute("stroke-opacity",i.outlineOpacity)):l.setAttribute("stroke","none"),i.fill)if(i.fillImage){var _=G.Browser.getImageSrc(i.fillImage),d=i.fillImageSize,u=t.svgImagePattern(a,_,d[0],d[1]);l.setAttribute("fill","url(#"+u+")"),l.setAttribute("fill-opacity",i.fillOpacity)}else if(i.gradual){var m=t.svgGradient(a,i.fillColor,i.fillOpacity);l.setAttribute("fill","url(#"+m+")")}else l.setAttribute("fill",i.fillColor),l.setAttribute("fill-opacity",i.fillOpacity);else l.setAttribute("fill","none")}}},_onStartEdit:function(){var e=this,t=e._layer._map,r=e.virtualMouse;for(i in r.DOWN)t.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,i=this,r=i._layer._map,a=i.virtualMouse;for(e in a.DOWN)t=a.DOWN[e],r.removeListener(t,i._onVertexDragStart,i),r.removeListener(a.MOVE[t],i._onVertexDrag,i),r.removeListener(a.UP[t],i._onVertexDragEnd,i);i._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer;if(t){var i=t._map,r=G.DomUtil,a=i._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,e._updateStyles(),e._isVertex?r.addClass(i._layersFrame,"g-edit"):r.addClass(i._layersFrame,"g-clickable")}},_onMouseOut:function(){var e=this,t=e._layer;if(t){var i=t._map,r=G.DomUtil,a=i._handlers.Drag;a&&!a._dragging,e._updateStyles(),e._isVertex?r.removeClass(i._layersFrame,"g-edit"):r.removeClass(i._layersFrame,"g-clickable")}}}),G.Graphic.MultiPolygon=G.Graphic.MultiPolygon.extend({_onAdded:function(){var e=this;e._dom||(e._dom=G.DomUtil.createSVG("g")),e._polygonss={};var t=e._layer._map;t&&t._requestRedraw()},_onRemoved:function(){var e=this,t=e._dom;t&&t.parentNode&&t.parentNode.removeChild(t);var i=e._layer._map;i&&i._requestRedraw()},_draw:function(){var e=this,t=G.DomUtil,i=(e.options,e._layer),r=i._map,a=e.geom;if(a&&a.m){var o=i._svg;e._dom&&o&&!e._dom.parentNode&&o.appendChild(e._dom);for(var n=r.getSize(),s=r.getDrawSize(),l=(s[0]-n[0])/2,_=(s[1]-n[1])/2,d=a.m,u=e.bbox,m=(u[0]+u[2])/2,c=(u[1]+u[3])/2,p=r._calcWrapPointRange([m,c])||[0,0],g=r.options.maxExtent,f=g[2]-g[0],v=p[0];v<=p[1];v++)for(var h=(e._polygonss[v]=e._polygonss[v]||[],0);h<d.length;h++){var y=e._polygonss[v][h];y||(y=e._polygonss[v][h]=t.createSVG("path"),y._graphic=e,e._dom.appendChild(y));for(var b,S,x,A,D,C="",L=d[h],k=0,w=L.length;k<w;k++){b=L[k],S="";for(var O=0,E=b.length;O<E;O++)x=r.toScreen([b[O][0]+v*f,b[O][1]],0,0,!0),A=x[0]+l,D=x[1]+_,S+=0===O?" M ":"",S+=1===O?" L ":" ",S+=A+" "+D;S+=" Z",C+=S}y.setAttribute("d",C)}e._updateStyles()}},_updateStyles:function(){var e=this,t=G.DomUtil,i=e.options,r=e._layer,a=r._defs;for(var o in e._polygonss){var n=e._polygonss[o];for(var s in n){var l=n[s];if(i.outline||e._mouseOver||e._editing?(l.setAttribute("stroke",e._editing?i.lineHighlightColor:i.outline?i.outlineColor:i.fillColor),l.setAttribute("stroke-dasharray",i.outlineDashArray.join(" ")),l.setAttribute("stroke-linecap",i.outlineCap),l.setAttribute("stroke-linejoin",i.outlineJoin),l.setAttribute("stroke-width",(i.outline?i.outlineWidth:0)+(e._mouseOver?i.lineHighlightWiden:0)),l.setAttribute("stroke-opacity",i.outlineOpacity)):l.setAttribute("stroke","none"),i.fill){if(i.fillImage){var _=G.Browser.getImageSrc(i.fillImage),d=i.fillImageSize,u=t.svgImagePattern(a,_,d[0],d[1]);l.setAttribute("fill","url(#"+u+")")}else l.setAttribute("fill",i.fillColor);l.setAttribute("fill-opacity",i.fillOpacity)}else l.setAttribute("fill","none")}}},_updateMask:function(){var e=this,t=G.DomUtil,i=(e.options,e._map),r=e.geom;if(r&&r.m){e._maskss=e._maskss||{};for(var a=i.getSize(),o=i.getDrawSize(),n=(o[0]-a[0])/2,s=(o[1]-a[1])/2,l=r.m,_=e.bbox,d=(_[0]+_[2])/2,u=(_[1]+_[3])/2,m=i._calcWrapPointRange([d,u])||[0,0],c=i.options.maxExtent,p=c[2]-c[0],g=m[0];g<=m[1];g++)for(var f=(e._maskss[g]=e._maskss[g]||[],0);f<l.length;f++){var v=e._masks[g][f];v||(v=e._masks[g][f]=t.createSVG("path"),v._graphic=e);for(var h,y,b,S,x,A="",D=l[f],C=0,L=D.length;C<L;C++){h=D[C],y="";for(var k=0,w=h.length;k<w;k++)b=i.toScreen([h[k][0]+g*p,h[k][1]],0,0,!0),S=b[0]+n,x=b[1]+s,y+=0===k?" M ":"",y+=1===k?" L ":" ",y+=S+" "+x;y+=" Z",A+=y}v.setAttribute("d",A)}}},_onStartEdit:function(){var e=this,t=e._layer._map,r=e.virtualMouse;for(i in r.DOWN)t.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,i=this,r=i._layer._map,a=i.virtualMouse;for(e in a.DOWN)t=a.DOWN[e],r.removeListener(t,i._onVertexDragStart,i),r.removeListener(a.MOVE[t],i._onVertexDrag,i),r.removeListener(a.UP[t],i._onVertexDragEnd,i);i._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.MultiPolyline=G.Graphic.MultiPolyline.extend({_onAdded:function(){var e=this;e._dom||(e._dom=G.DomUtil.createSVG("g")),e._polyliness={};var t=e._layer._map;t&&t._requestRedraw()},_onRemoved:function(){var e=this,t=e._dom;t&&t.parentNode&&t.parentNode.removeChild(t);var i=e._layer._map;i&&i._requestRedraw()},_draw:function(){var e=this,t=G.DomUtil,i=(e.options,e._layer),r=i._map,a=e.geom;if(a&&a.m){var o=i._svg;e._dom&&o&&!e._dom.parentNode&&o.appendChild(e._dom);for(var n=r.getSize(),s=r.getDrawSize(),l=(s[0]-n[0])/2,_=(s[1]-n[1])/2,d=a.m,u=e.bbox,m=(u[0]+u[2])/2,c=(u[1]+u[3])/2,p=r._calcWrapPointRange([m,c])||[0,0],g=r.options.maxExtent,f=g[2]-g[0],v=p[0];v<=p[1];v++)for(var h=(e._polyliness[v]=e._polyliness[v]||[],
0);h<d.length;h++){var y=e._polyliness[v][h];y||(y=e._polyliness[v][h]=t.createSVG("polyline"),y._graphic=e,e._dom.appendChild(y));for(var b,S,x,A="",D=d[h],C=0,L=D.length;C<L;C++)b=r.toScreen([D[C][0]+v*f,D[C][1]],0,0,!0),S=b[0]+l,x=b[1]+_,A+=A?" ":"",A+=S+","+x;y.setAttribute("points",A)}e._updateStyles()}},_updateStyles:function(){var e=this,t=e.options;for(var i in e._polyliness){var r=e._polyliness[i];for(var a in r){var o=r[a];o.setAttribute("stroke",e._editing?t.lineHighlightColor:t.lineColor),o.setAttribute("stroke-dasharray",t.lineDashArray.join(" ")),o.setAttribute("stroke-linecap",t.lineCap),o.setAttribute("stroke-linejoin",t.lineJoin),o.setAttribute("stroke-opacity",t.lineOpacity),o.setAttribute("stroke-width",e._mouseOver?t.lineWidth+t.lineHighlightWiden:t.lineWidth),o.setAttribute("fill","none")}}},_onStartEdit:function(){var e=this,t=e._layer._map,r=e.virtualMouse;for(i in r.DOWN)t.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,i=this,r=i._layer._map,a=i.virtualMouse;for(e in a.DOWN)t=a.DOWN[e],r.removeListener(t,i._onVertexDragStart,i),r.removeListener(a.MOVE[t],i._onVertexDrag,i),r.removeListener(a.UP[t],i._onVertexDragEnd,i);i._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Point=G.Graphic.Point.extend({_onAdded:function(){var e=this;e._dom||(e._dom=G.DomUtil.createSVG("g")),e._points={};var t=e._layer._map;t&&t._requestRedraw()},_onRemoved:function(){var e=this,t=e._dom;t&&t.parentNode&&t.parentNode.removeChild(t);var i=e._layer._map;i&&i._requestRedraw()},_draw:function(){var e=this,t=G.DomUtil,i=e.options,r=e._layer,a=r._map;if(e.geom){var o=r._svg;e._dom&&o&&!e._dom.parentNode&&o.appendChild(e._dom);var n=a.getSize(),s=a.getDrawSize(),l=(s[0]-n[0])/2,_=(s[1]-n[1])/2,d=a._rotate,u=i.shape,m=i.size,c=m[0],p=m[1],g=i.offset,f=i.imageRotate;"image"==u&&f&&(d-=f),"image"!=u||i.imageGravity||(d-=a._rotate);for(var v=e.geom[0],h=e.geom[1],y=a._calcWrapPointRange(e.geom)||[0,0],b=a.options.maxExtent,S=b[2]-b[0],x=y[0];x<=y[1];x++){var A=e._points[x];A||(A="rect"==u?e._points[x]=t.createSVG("rect"):"image"==u?e._points[x]=t.createSVG("image"):"text"==u?e._points[x]=t.createSVG("text"):e._points[x]=t.createSVG("circle"),A._graphic=e,e._dom.appendChild(A));var D=a.toScreen([v+x*S,h],0,0,!0),C=D[0]+l,L=D[1]+_,k=C+g[0],w=L+g[1],O="rotate("+-d+","+C+","+L+")";if("circle"==u)A.setAttribute("cx",k),A.setAttribute("cy",w),A.setAttribute("r",c/2);else if("rect"==u)A.setAttribute("x",k-c/2),A.setAttribute("y",w-p/2),A.setAttribute("width",c),A.setAttribute("height",p);else if("image"==u){A.setAttribute("x",k),A.setAttribute("y",w),A.setAttribute("width",c),A.setAttribute("height",p);var E=G.Browser.getImageSrc(i.image);A.setAttributeNS(G.DomUtil.XLINK_NS,"href",E)}else if("text"==u){var U=i.text;if(!e._textMeasureWidth||e._textMeasure!=U){var N=t.create("div","",document.body);N.style.position="absolute",N.style.visibility="hidden",N.style.width=N.style.height="auto",N.style.fontFamily=i.textFont,N.style.fontStyle="italic"==i.textStyle?"italic":"normal",N.style.fontWeight="bold"==i.textStyle?"bold":"normal",N.style.fontSize=c+"px",N.innerHTML=U,e._textMeasureWidth=N.clientWidth+4,N.parentNode.removeChild(N),e._textMeasure=U}A.setAttribute("x",k),A.setAttribute("y",w),A.setAttribute("font-size",c+"px"),A.setAttribute("text-anchor","center"==i.textAlign?"middle":"left"==i.textAlign?"start":"end"),A.setAttribute("alignment-baseline","middle"),A.setAttribute("font-family",i.textFont),A.setAttribute("font-style","italic"==i.textStyle?"italic":"normal"),A.setAttribute("font-weight","bold"==i.textStyle?"bold":"normal"),A.innerHTML=A.textContent=i.text}A.setAttribute("transform",O)}e._updateStyles()}},_updateStyles:function(){var e=this,t=G.DomUtil,i=e.options,r=e._layer,a=r._defs;for(var o in e._points){var n=e._points[o];if((i.outline||e._mouseOver||e._editing)&&"text"!=i.shape?(n.setAttribute("stroke",e._editing?i.lineHighlightColor:i.outline?i.outlineColor:i.fillColor),n.setAttribute("stroke-dasharray",i.outlineDashArray.join(" ")),n.setAttribute("stroke-width",e._mouseOver?i.outlineWidth+i.lineHighlightWiden:i.outlineWidth),n.setAttribute("stroke-opacity",i.outlineOpacity)):n.setAttribute("stroke","none"),i.fill)if(i.fillImage){var s=G.Browser.getImageSrc(i.fillImage),l=i.fillImageSize,_=t.svgImagePattern(a,s,l[0],l[1]);n.setAttribute("fill","url(#"+_+")"),n.setAttribute("fill-opacity",i.fillOpacity)}else if(i.gradual){var d=t.svgGradient(a,i.fillColor,i.fillOpacity);n.setAttribute("fill","url(#"+d+")")}else n.setAttribute("fill",i.fillColor),n.setAttribute("fill-opacity",i.fillOpacity);else n.setAttribute("fill","none")}},_onStartEdit:function(){var e=this,t=e._layer._map,r=e.virtualMouse;for(i in r.DOWN)t.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,i=this,r=i._layer._map,a=i.virtualMouse;for(e in a.DOWN)t=a.DOWN[e],r.removeListener(t,i._onVertexDragStart,i),r.removeListener(a.MOVE[t],i._onVertexDrag,i),r.removeListener(a.UP[t],i._onVertexDragEnd,i);i._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer;if(t){var i=t._map,r=G.DomUtil,a=i._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,e._updateStyles(),e._isVertex?r.addClass(i._layersFrame,"g-edit"):r.addClass(i._layersFrame,"g-clickable")}},_onMouseOut:function(){var e=this,t=e._layer;if(t){var i=t._map,r=G.DomUtil,a=i._handlers.Drag;a&&!a._dragging,e._updateStyles(),e._isVertex?r.removeClass(i._layersFrame,"g-edit"):r.removeClass(i._layersFrame,"g-clickable")}}}),G.Graphic.Polygon=G.Graphic.Polygon.extend({_onAdded:function(){var e=this;e._dom||(e._dom=G.DomUtil.createSVG("g")),e._polygons={};var t=e._layer._map;t&&t._requestRedraw()},_onRemoved:function(){var e=this,t=e._dom;t&&t.parentNode&&t.parentNode.removeChild(t);var i=e._layer._map;i&&i._requestRedraw()},_draw:function(){var e=this,t=G.DomUtil,i=(e.options,e._layer),r=i._map;if(e.geom){var a=i._svg;e._dom&&a&&!e._dom.parentNode&&a.appendChild(e._dom);for(var o=r.getSize(),n=r.getDrawSize(),s=(n[0]-o[0])/2,l=(n[1]-o[1])/2,_=e.geom,d=(_.length,e.bbox),u=(d[0]+d[2])/2,m=(d[1]+d[3])/2,c=r._calcWrapPointRange([u,m])||[0,0],p=r.options.maxExtent,g=p[2]-p[0],f=c[0];f<=c[1];f++){var v=e._polygons[f];v||(v=e._polygons[f]=t.createSVG("path"),v._graphic=e,e._dom.appendChild(v));for(var h,y,b,S,x,A="",D=0,C=_.length;D<C;D++){h=_[D],y="";for(var L=0,k=h.length;L<k;L++)b=r.toScreen([h[L][0]+f*g,h[L][1]],0,0,!0),S=b[0]+s,x=b[1]+l,y+=0===L?" M ":"",y+=1===L?" L ":" ",y+=S+" "+x;y+=" Z",A+=y}v.setAttribute("d",A)}e._updateStyles()}},_updateStyles:function(){var e=this,t=G.DomUtil,i=e.options,r=e._layer,a=r._defs;for(var o in e._polygons){var n=e._polygons[o];if(i.outline||e._mouseOver||e._editing?(n.setAttribute("stroke",e._editing?i.lineHighlightColor:i.outline?i.outlineColor:i.fillColor),n.setAttribute("stroke-dasharray",i.outlineDashArray.join(" ")),n.setAttribute("stroke-linecap",i.outlineCap),n.setAttribute("stroke-linejoin",i.outlineJoin),n.setAttribute("stroke-width",(i.outline?i.outlineWidth:0)+(e._mouseOver?i.lineHighlightWiden:0)),n.setAttribute("stroke-opacity",i.outlineOpacity)):n.setAttribute("stroke","none"),i.fill){if(i.fillImage){var s=G.Browser.getImageSrc(i.fillImage),l=i.fillImageSize,_=t.svgImagePattern(a,s,l[0],l[1]);n.setAttribute("fill","url(#"+_+")")}else n.setAttribute("fill",i.fillColor);n.setAttribute("fill-opacity",i.fillOpacity)}else n.setAttribute("fill","none")}},_updateMask:function(){var e=this,t=G.DomUtil,i=(e.options,e._map);if(e.geom){e._masks=e._masks||{};for(var r=i.getSize(),a=i.getDrawSize(),o=(a[0]-r[0])/2,n=(a[1]-r[1])/2,s=e.geom,l=(s.length,e.bbox),_=(l[0]+l[2])/2,d=(l[1]+l[3])/2,u=i._calcWrapPointRange([_,d])||[0,0],m=i.options.maxExtent,c=m[2]-m[0],p=u[0];p<=u[1];p++){var g=e._masks[p];g||(g=e._masks[p]=t.createSVG("path"),g._graphic=e);for(var f,v,h,y,b,S="",x=0,A=s.length;x<A;x++){f=s[x],v="";for(var D=0,C=f.length;D<C;D++)h=i.toScreen([f[D][0]+p*c,f[D][1]],0,0,!0),y=h[0]+o,b=h[1]+n,v+=0===D?" M ":"",v+=1===D?" L ":" ",v+=y+" "+b;v+=" Z",S+=v}g.setAttribute("d",S)}}},_onStartEdit:function(){var e=this,t=e._layer._map,r=e.virtualMouse;for(i in r.DOWN)t.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,i=this,r=i._layer._map,a=i.virtualMouse;for(e in a.DOWN)t=a.DOWN[e],r.removeListener(t,i._onVertexDragStart,i),r.removeListener(a.MOVE[t],i._onVertexDrag,i),r.removeListener(a.UP[t],i._onVertexDragEnd,i);i._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Polyline=G.Graphic.Polyline.extend({_onAdded:function(){var e=this;e._dom||(e._dom=G.DomUtil.createSVG("g")),e._polylines={};var t=e._layer._map;t&&t._requestRedraw()},_onRemoved:function(){var e=this,t=e._dom;t&&t.parentNode&&t.parentNode.removeChild(t);var i=e._layer._map;i&&i._requestRedraw()},_draw:function(){var e=this,t=G.DomUtil,i=(e.options,e._layer),r=i._map;if(e.geom){var a=i._svg;e._dom&&a&&!e._dom.parentNode&&a.appendChild(e._dom);for(var o=r.getSize(),n=r.getDrawSize(),s=(n[0]-o[0])/2,l=(n[1]-o[1])/2,_=e.geom,d=_.length,u=e.bbox,m=(u[0]+u[2])/2,c=(u[1]+u[3])/2,p=r._calcWrapPointRange([m,c])||[0,0],g=r.options.maxExtent,f=g[2]-g[0],v=p[0];v<=p[1];v++){var h=e._polylines[v];h||(h=e._polylines[v]=t.createSVG("polyline"),h._graphic=e,e._dom.appendChild(h));for(var y,b,S,x="",A=0;A<d;A++)y=r.toScreen([_[A][0]+v*f,_[A][1]],0,0,!0),b=y[0]+s,S=y[1]+l,x+=x?" ":"",x+=b+","+S;h.setAttribute("points",x)}e._updateStyles()}},_updateStyles:function(){var e=this,t=e.options;for(var i in e._polylines){var r=e._polylines[i];r.setAttribute("stroke",e._editing?t.lineHighlightColor:t.lineColor),r.setAttribute("stroke-dasharray",t.lineDashArray.join(" ")),r.setAttribute("stroke-linecap",t.lineCap),r.setAttribute("stroke-linejoin",t.lineJoin),r.setAttribute("stroke-opacity",t.lineOpacity),r.setAttribute("stroke-width",e._mouseOver?t.lineWidth+t.lineHighlightWiden:t.lineWidth),r.setAttribute("fill","none")}},_onStartEdit:function(){var e=this,t=e._layer._map,r=e.virtualMouse;for(i in r.DOWN)t.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,i=this,r=i._layer._map,a=i.virtualMouse;for(e in a.DOWN)t=a.DOWN[e],r.removeListener(t,i._onVertexDragStart,i),r.removeListener(a.MOVE[t],i._onVertexDrag,i),r.removeListener(a.UP[t],i._onVertexDragEnd,i);i._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,i=t._handlers.Drag;i&&!i._dragging,e._updateStyles(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Map=G.Map.extend({_initAddition:function(){var e=this,t=G.DomUtil,i=e._maskFrame,r="g-graphic-container g-zoom-animated",a=i._svg=t.createSVG("svg",r,i),o=i._defs=t.createSVG("defs","",a),n=i._mask=t.createSVG("mask","",o);n.setAttribute("id","svg_mask");var s=n._base=t.createSVG("rect","",n);s.setAttribute("width","100%"),s.setAttribute("height","100%"),s.setAttribute("fill","#fff"),e._mode="svg"},_drawMask:function(){var e=this,t=e.options,i=G.DomUtil,r=e._maskFrame,a=r._svg,o=r._mask;if(!(t.mask&&e._masks&&e._masks.length>0))return void i.hide(a);i.show(a);var n=i.getPosition(e._mapFrame),s=e.getSize(),l=e.getDrawSize(),_=l[0],d=l[1],u=(_-s[0])/2,m=(d-s[1])/2;a.style[i.Transform]=i.genTranslateStyle(-u,-m),a.setAttribute("width",_),a.setAttribute("height",d),a.setAttribute("viewBox",[-n[0],-n[1],_,d].join(" "));var c,p,g,f=e.getCenter(),v=e._res,h=f[0]-_*v/2,y=f[0]+_*v/2,b=f[1]-d*v/2,S=f[1]+d*v/2,x=[h,b,y,S],A=e.options.maxExtent;G.ExtentUtil.intersect(x,A);for(p in e._masks){c=e._masks[p],g=c.bbox,c._updateMask();for(var D in c._masks){var C=c._masks[D];C&&(C.parentNode||o.appendChild(C))}}var L=(o._base,a._rect=a._rect?a._rect:i.createSVG("rect"));L.setAttribute("x",-n[0]),L.setAttribute("y",-n[1]),L.setAttribute("width",_),L.setAttribute("height",d),L.setAttribute("mask","url(#svg_mask)"),L.setAttribute("fill",t.maskColor),L.setAttribute("fill-opacity",t.maskOpacity),L.parentNode||a.appendChild(L)},_onZoomStart:function(e){var t=this,i=t._mapFrame,r=t._maskFrame,a=r._svg,o=t._rotate,n=G.DomUtil,s=n.Transition,l=n.Transform;self._zooming||(self._zooming=!0);var _=t.getSize(),d=t.getDrawSize(),u=d[0],m=d[1],c=(u-_[0])/2,p=(m-_[1])/2,g=[_[0]/2,_[1]/2],f=e.aroundScreen||g,v=g[0]-f[0],h=g[1]-f[1];if(o&&v&&h){var y=G.MathUtil.rotateVector([v,h],-o);f=[g[0]-y[0],g[1]-y[1]]}f=self._aroundScreen=[f[0]-g[0],f[1]-g[1]];var b=G.DomUtil.genScaleStyle(1/e.scale,f[0],f[1],-c,-p);a.style[l]=b;var S=t._zoomAnim&&t._zoomAnim._params.ignoreAnim;S||(a.style[s]=i.style[s])},_onZoomUpdate:function(e){var t=this,i=t._mapFrame,r=t._maskFrame,a=r._svg,o=G.DomUtil,n=o.Transition,s=o.Transform;if(self._zooming){var l=self._aroundScreen,_=t.getSize(),d=t.getDrawSize(),u=d[0],m=d[1],c=(u-_[0])/2,p=(m-_[1])/2,g=G.DomUtil.genScaleStyle(1/e.scale,l[0],l[1],-c,-p);a.style[s]=g;var f=t._zoomAnim&&t._zoomAnim._params.ignoreAnim;f||(a.style[n]=i.style[n])}},_onZoomEnd:function(){var e=this,t=e._maskFrame,i=t._svg,r=G.DomUtil,a=e.getSize(),o=e.getDrawSize(),n=o[0],s=o[1],l=(n-a[0])/2,_=(s-a[1])/2;i.style.visibility="",i.parentNode.appendChild(i),i.style[r.Transform]=r.genTranslateStyle(-l,-_),i.style[r.Transition]="",self._zooming=!1}});